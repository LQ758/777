<!DOCTYPE html><html lang="zh-CN"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯­è¨€å­¦ä¹ åŠ©æ‰‹ | è¯­éŸ³è¯„åˆ†ä¸è¯­æ³•æ£€æµ‹</title>
    
    <!-- å¤–éƒ¨CDNèµ„æº - åŸå§‹ç‰ˆæœ¬ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/axios@1.6.0/dist/axios.min.js"></script>
    <script src="/static/test_api.js"></script>

<style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', 'Noto Sans', system-ui, sans-serif;
            background-color: #E9F1FF;
            color: #212529;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .app-container {
            width: 1440px;
            min-height: 800px;
            padding: 32px;
            display: flex;
            flex-direction: column;
        }
        
        .content-card {
            background: #FFFFFF;
            border: 1px solid #E9ECEF;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 24px -4px rgba(0,0,0,0.04);
            overflow: hidden;
            flex: 1;
            padding: 32px;
        }
        
        header.navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 0 32px 0;
        }
        
        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.4rem;
            font-weight: 700;
        }
        
        .tabs {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
        }
        
        .tab-btn {
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: #495057;
        }
        
        .tab-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        
        .module {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .module.active {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 32px;
            height: 100%;
        }
        
        .panel {
            display: flex;
            flex-direction: column;
            gap: 24px;
            height: 100%;
        }
        
        h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #212529;
            margin-bottom: 8px;
        }
        
        .description {
            color: #868E96;
            margin-bottom: 20px;
        }
        
        .sentence-box {
            background: #F8F9FA;
            padding: 24px;
            border-radius: 8px;
            font-size: 1.3rem;
            text-align: center;
        }
        
        .dashboard {
            background: #F8F9FA;
            border-radius: 8px;
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .score-display {
            font-size: 5rem;
            font-weight: 800;
            margin: 24px 0;
            transition: color 0.4s;
        }
        
        .score-rating {
            font-size: 1.4rem;
            font-weight: 600;
            color: #FB8500;
        }
        
        .chart-container {
            width: 100%;
            height: 180px;
        }
        
        .recorder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 24px;
        }
        
        .rec-btn {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #3A86FF;
            color: white;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            border: none;
            box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5);
        }
        
        .rec-btn:hover {
            background: #2B6BC8;
        }
        
        .recording .rec-btn {
            animation: pulse 1.5s infinite;
        }
        
        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: #495057;
        }
        
        input, textarea {
            width: 100%;
            padding: 16px;
            border: 1px solid #DEE2E6;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .error-text {
            background: #FFF5F5;
            padding: 24px;
            border-radius: 8px;
            position: relative;
        }
        
        .highlight {
            background: rgba(230, 57, 70, 0.12);
            color: #E63946;
            border-bottom: 2px dashed #E63946;
        }
        
        .upload-area {
            border: 2px dashed #DEE2E6;
            border-radius: 8px;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .upload-area:hover {
            border-color: #3A86FF;
        }
        
        .upload-icon {
            background: #F1F3F5;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            color: #3A86FF;
        }
        
        .file-desc {
            color: #868E96;
            margin-bottom: 16px;
        }
        
        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 0 0 0;
            color: #868E96;
            border-top: 1px solid #E9ECEF;
            margin-top: 32px;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .progress-bar {
            width: 160px;
            height: 6px;
            background: #E9ECEF;
            border-radius: 3px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #3A86FF;
            width: 65%;
        }
        
        .setting-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0.5); }
            70% { box-shadow: 0 0 0 12px rgba(58, 134, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(58, 134, 255, 0); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .mode-selector {
            display: flex;
            background: #F1F3F5;
            border-radius: 6px;
            padding: 4px;
            margin-bottom: 24px;
        }
        
        .mode-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mode-btn.active {
            background: #FFFFFF;
            color: #3A86FF;
            font-weight: 600;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        
        /* è¯­éŸ³è¾“å…¥ç›¸å…³æ ·å¼ */
        .voice-input-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #F0F4FF;
            border: 1px solid #3A86FF;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .voice-input-toggle:hover {
            background: #E9F1FF;
        }
        
        .voice-record-btn {
            position: relative;
            background: #3A86FF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(58, 134, 255, 0.3);
        }
        
        .voice-record-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(58, 134, 255, 0.4);
        }
        
        .voice-record-btn.recording {
            background: #E63946;
            animation: pulse 1.5s infinite;
        }
        
        .voice-input-controls {
            text-align: center;
            padding: 20px;
            background: #F8F9FA;
            border-radius: 8px;
            border: 2px dashed #3A86FF;
        }
        
        .success-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #52B788, #40916C);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(82, 183, 136, 0.3);
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .disabled-input {
            background: #F8F9FA !important;
            color: #868E96 !important;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="navbar">
            <div class="brand">
                <span class="icon icon-language"></span>
                <span>æ„Ÿè§‰å·®ç‚¹ä»€ä¹ˆçš„è¯­å­¦åŠ©æ‰‹</span>
            </div>
            <div class="tabs">
                <div class="tab-btn active" data-target="speech">è‹±è¯­è¯­éŸ³è¯„åˆ†</div>
                <div class="tab-btn" data-target="grammar">è‹±æ–‡è¯­æ³•æ£€æµ‹</div>
                <div class="tab-btn" data-target="custom">è‡ªå®šä¹‰ç»ƒä¹ </div>
            </div>
            <div class="user-section" id="user-section" style="display: flex; align-items: center; gap: 12px;">
                <!-- ç™»å½•çŠ¶æ€æ˜¾ç¤º -->
                <div id="user-info" style="display: none; align-items: center; gap: 8px;">
                    <span class="icon icon-account-circle" style="font-size: 1.5rem; color: #3A86FF;"></span>
                    <span id="username-display" style="color: #495057; font-weight: 600;"></span>
                    <button id="logout-btn" style="background: #E63946; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem;">ç™»å‡º</button>
                </div>
                
                <!-- æœªç™»å½•çŠ¶æ€æ˜¾ç¤º -->
                <div id="guest-info" style="display: flex; align-items: center; gap: 8px;">
                    <a href="/login" style="background: #3A86FF; color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">ç™»å½•</a>
                </div>
            </div>
        </header>
        
        <main class="content-card">
            <!-- è¯­éŸ³è¯„åˆ†æ¨¡å— -->
            <div id="speech" class="module active">
                <div class="panel">
                    <div>
                        <h2>è‹±è¯­å‘éŸ³è¯„åˆ†</h2>
                        <p class="description">æœ—è¯»ä»¥ä¸‹è‹±è¯­å¥å­ï¼Œç³»ç»Ÿå°†è¯„ä¼°æ‚¨çš„å‘éŸ³å‡†ç¡®åº¦å¹¶ç»™å‡ºæ”¹è¿›å»ºè®®</p>
                        <div class="sentence-box">
                            The pursuit of knowledge and innovation drives human progress.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>ç”Ÿæˆæ–°å¥å­</span>
                        </button>
                    </div>
                    
                    <div class="recorder">
                        <div>
                            <p class="timer">00:00</p>
                            <button class="rec-btn">
                                <iconify-icon icon="mdi:microphone" width="32" height="32"></iconify-icon>
                            </button>
                        </div>
                        <div class="chart-container" id="waveform"></div>
                        
                        <!-- æ·»åŠ è¯„åˆ†æ¨¡å¼åˆ‡æ¢ -->
                        <div style="margin-top: 16px; text-align: center;">
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer; margin-bottom: 8px;">
                                <input type="checkbox" id="useSimpleScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">ä½¿ç”¨ç®€åŒ–è¯„åˆ†æ¨¡å¼</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; justify-content: center; cursor: pointer;">
                                <input type="checkbox" id="useDetailedScoring" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">å¯ç”¨å®Œæ•´æ¨¡å¼è¯¦ç»†åˆ†æ</span>
                            </label>
                            <p style="font-size: 0.8rem; color: #868E96; margin-top: 4px;">
                                ç®€åŒ–æ¨¡å¼æ›´ç¨³å®šï¼Œå®Œæ•´æ¨¡å¼æä¾›è¯¦ç»†çš„å‘éŸ³æ”¹è¿›å»ºè®®
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard">
                    <h2>æˆç»©åˆ†æ</h2>
                    <div class="score-display" style="color: #3A86FF">0</div>
                    <div class="score-rating">æœªè¯„åˆ†</div>
                    
                    <div class="chart-container" id="score-dashboard"></div>
                    
                    <div style="margin-top: 24px; text-align: center;">
                        <p style="margin-bottom: 12px; color: #495057">å‘éŸ³æ”¹å–„å»ºè®®:</p>
                    </div>
                </div>
            </div>
            
            <!-- è¯­æ³•æ£€æµ‹æ¨¡å— -->
            <div id="grammar" class="module">
                <div class="panel">
                    <div>
                        <h2>è‹±æ–‡è¯­æ³•æ£€æµ‹</h2>
                        <p class="description">è¾“å…¥è‹±æ–‡æ–‡æœ¬ï¼Œç³»ç»Ÿå°†æ£€æµ‹è¯­æ³•é”™è¯¯å¹¶æä¾›ä¿®æ”¹å»ºè®®</p>
                        <div class="sentence-box">
                            I have went to the store yesterday and buyed some groceries.
                        </div>
                        <button class="generate-sentence-btn" style="background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px;">
                            <iconify-icon icon="mdi:refresh" width="20" height="20"></iconify-icon>
                            <span>ç”Ÿæˆæ–°å¥å­</span>
                        </button>
                    </div>
                    
                    <div>
                        <!-- è¯­éŸ³è¾“å…¥é€‰é¡¹ -->
                        <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="checkbox" id="voice-input-toggle" style="width: auto;">
                                <span style="font-size: 0.9rem; color: #495057;">ğŸ¤ å¯ç”¨è¯­éŸ³è¾“å…¥</span>
                            </label>
                            <span style="font-size: 0.8rem; color: #868E96;">ï¼ˆå‹¾é€‰åå°†ä½¿ç”¨Whisperæ¨¡å‹è¯†åˆ«è¯­éŸ³è½¬æ–‡å­—ï¼‰</span>
                        </div>
                        
                        <textarea id="grammar-text-input" rows="6" placeholder="åœ¨æ­¤è¾“å…¥æ‚¨çš„è‹±æ–‡æ–‡æœ¬...">I have went to the store yesterday and buyed some groceries.</textarea>
                        
                        <!-- è¯­éŸ³è¾“å…¥æ§åˆ¶åŒºåŸŸ -->
                        <div id="voice-input-controls" style="display: none; margin-top: 16px; text-align: center;">
                            <button id="voice-record-btn" style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; margin: 0 auto;">
                                <iconify-icon icon="mdi:microphone" width="20" height="20"></iconify-icon>
                                <span>å¼€å§‹å½•éŸ³</span>
                            </button>
                            <p style="font-size: 0.8rem; color: #868E96; margin-top: 8px;">ç‚¹å‡»å½•éŸ³æŒ‰é’®ï¼Œè¯´å‡ºæ‚¨è¦æ£€æµ‹çš„è‹±æ–‡å†…å®¹</p>
                        </div>
                        
                        <!-- æäº¤æ£€æµ‹æŒ‰é’® -->
                        <button id="submit-grammar-check" style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px; display: flex; align-items: center; gap: 8px; width: 100%; justify-content: center;">
                            <iconify-icon icon="mdi:check-circle" width="20" height="20"></iconify-icon>
                            <span>æäº¤æ£€æµ‹</span>
                        </button>
                        

                    </div>
                </div>
                
                <div class="panel" style="height: 100%;">
                    <h2>è¯­æ³•åˆ†æ</h2>
                    <div class="error-text">
                        <p>I have <span class="highlight">went</span> to the store yesterday and <span class="highlight">buyed</span> some groceries.</p>
                        <p style="margin-top: 24px;">ä¿®æ”¹å»ºè®®:</p>
                        <p style="margin-top: 8px;">1. "went" åº”ä¸º "gone"ï¼ˆ"have" ååº”ä½¿ç”¨è¿‡å»åˆ†è¯ï¼‰</p>
                        <p>2. "buyed" ä¸ºé”™è¯¯å½¢å¼ï¼Œæ­£ç¡®çš„è¿‡å»å¼æ˜¯ "bought"</p>
                        <p>æ­£ç¡®å½¢å¼: <strong>I have gone to the store yesterday and bought some groceries.</strong></p>
                    </div>
                </div>
            </div>
            
            <!-- è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— -->
            <div id="custom" class="module">
                <div class="panel">
                    <div>
                        <h2>è‡ªå®šä¹‰ç»ƒä¹ </h2>
                        <p class="description">å¯¼å…¥å­¦ä¹ ææ–™ï¼Œåˆ›å»ºä¸ªæ€§åŒ–ç»ƒä¹ å†…å®¹</p>
                        
                        <div class="mode-selector">
                            <div class="mode-btn active" data-mode="text">æ–‡æœ¬å¯¼å…¥</div>
                            <div class="mode-btn" data-mode="practice">å¼€å§‹ç»ƒä¹ </div>
                        </div>
                        
                        <!-- æ–‡æœ¬å¯¼å…¥åŒºåŸŸ -->
                        <div id="text-import-area">
                            <textarea id="import-text-area" rows="8" style="width: 100%; padding: 16px; border: 1px solid #DEE2E6; border-radius: 6px; font-size: 1rem; margin-bottom: 12px;" placeholder="è¾“å…¥ç»ƒä¹ å†…å®¹ï¼š

çº¯è‹±æ–‡å¥å­ï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰ï¼šç”¨äºè¯­éŸ³ç»ƒä¹ 
Hello world
How are you today

ä¸­æ–‡|è‹±æ–‡ï¼ˆç”¨|åˆ†éš”ï¼‰ï¼šç”¨äºç¿»è¯‘ç»ƒä¹ 
æˆ‘çˆ±å­¦ä¹ |I love learning
ä»Šå¤©å¤©æ°”å¾ˆå¥½|The weather is nice today"></textarea>
                            <input type="text" id="exercise-name-input" placeholder="ç»ƒä¹ é›†åç§°ï¼ˆå¯é€‰ï¼‰" style="width: 100%; padding: 12px; border: 1px solid #DEE2E6; border-radius: 6px; margin-bottom: 12px;">
                            <button id="import-text-btn" style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; width: 100%;">
                                <iconify-icon icon="mdi:import" width="20" height="20" style="vertical-align: middle;"></iconify-icon>
                                å¯¼å…¥æ–‡æœ¬åˆ›å»ºç»ƒä¹ é›†
                            </button>
                        </div>
                        
                        <!-- ç»ƒä¹ æ¨¡å¼é€‰æ‹©åŒºåŸŸ -->
                        <div id="practice-mode-area" style="display: none;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">é€‰æ‹©ç»ƒä¹ é›†</label>
                                <select id="practice-exercise-select" style="width: 100%; padding: 12px; border: 1px solid #DEE2E6; border-radius: 6px;">
                                    <option value="">é€‰æ‹©ç»ƒä¹ é›†...</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">ç»ƒä¹ ç±»å‹</label>
                                <select id="practice-type-select" style="width: 100%; padding: 12px; border: 1px solid #DEE2E6; border-radius: 6px;">
                                    <option value="speech">ğŸ¤ è¯­éŸ³ç»ƒä¹ </option>
                                    <option value="phoneme">ğŸ”Š éŸ³ç´ è¯„åˆ†</option>
                                    <option value="grammar">âœï¸ è¯­æ³•æ£€æµ‹</option>
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #495057;">éš¾åº¦ <span style="font-size: 0.8rem; color: #868E96;">(å½±å“å¥å­é•¿åº¦å’Œå¤æ‚åº¦)</span></label>
                                <select id="difficulty-select" style="width: 100%; padding: 12px; border: 1px solid #DEE2E6; border-radius: 6px;">
                                    <option value="">å…¨éƒ¨ - éšæœºé€‰æ‹©ä»»æ„éš¾åº¦</option>
                                    <option value="easy">ç®€å• - çŸ­å¥å­ï¼Œå¸¸ç”¨è¯æ±‡</option>
                                    <option value="medium" selected>ä¸­ç­‰ - ä¸­ç­‰é•¿åº¦ï¼Œæ­£å¸¸éš¾åº¦</option>
                                    <option value="hard">å›°éš¾ - é•¿å¥å­ï¼Œå¤æ‚è¯­æ³•</option>
                                </select>
                            </div>
                            <button id="start-custom-practice-btn" style="width: 100%; background: #3A86FF; color: white; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                                ğŸ¯ å¼€å§‹ç»ƒä¹ 
                            </button>
                        </div>
                    </div>
                    
                    <!-- è¿›åº¦ç»Ÿè®¡ -->
                    <div style="margin-top: 24px; padding: 16px; background: #F8F9FA; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 12px;">
                            <span style="color: #868E96;">ç»ƒä¹ è¿›åº¦</span>
                            <span id="progressPercent" style="font-weight: 600; color: #3A86FF;">0%</span>
                        </div>
                        <div class="progress-bar" style="width: 100%; height: 8px; background: #E9ECEF; border-radius: 4px; overflow: hidden;">
                            <div id="progressFill" class="progress-fill" style="height: 100%; background: #3A86FF; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px;">
                            <div style="text-align: center;">
                                <div id="totalItems" style="font-size: 1.5rem; font-weight: 700; color: #3A86FF;">0</div>
                                <div style="font-size: 0.875rem; color: #868E96;">æ€»é¢˜æ•°</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="completedItems" style="font-size: 1.5rem; font-weight: 700; color: #52B788;">0</div>
                                <div style="font-size: 0.875rem; color: #868E96;">å·²å®Œæˆ</div>
                            </div>
                            <div style="text-align: center;">
                                <div id="avgScore" style="font-size: 1.5rem; font-weight: 700; color: #FFD166;">--</div>
                                <div style="font-size: 0.875rem; color: #868E96;">å¹³å‡åˆ†</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div style="height: 100%; display: flex; flex-direction: column;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 style="margin: 0;">ç»ƒä¹ åŒºåŸŸ</h2>
                        </div>
                        
                        <!-- ç»ƒä¹ å†…å®¹æ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="custom-exercise-content" style="flex: 1; padding: 20px; background: #F8F9FA; border-radius: 8px; text-align: center; margin-bottom: 16px;">
                            <div style="color: #868E96;">
                                <iconify-icon icon="mdi:book-open-variant" width="64" height="64" style="color: #DEE2E6; margin-bottom: 16px;"></iconify-icon>
                                <p>è¯·å…ˆåˆ›å»ºæˆ–é€‰æ‹©ç»ƒä¹ é›†ï¼Œç„¶ååˆ‡æ¢åˆ°â€œå¼€å§‹ç»ƒä¹ â€æ¨¡å¼</p>
                            </div>
                        </div>
                        
                        <!-- ç”¨æˆ·è¾“å…¥åŒºåŸŸ -->
                        <div id="custom-input-area" style="display: none; margin-bottom: 16px;">
                            <textarea id="custom-answer-input" placeholder="è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„è‹±æ–‡ç¿»è¯‘..." style="width: 100%; padding: 12px; border: 1px solid #DEE2E6; border-radius: 6px; min-height: 80px; resize: vertical;"></textarea>
                        </div>
                        
                        <!-- æ§åˆ¶æŒ‰é’®åŒºåŸŸ -->
                        <div id="custom-exercise-controls" style="text-align: center;"></div>
                        
                        <!-- ç»“æœæ˜¾ç¤ºåŒºåŸŸ -->
                        <div id="custom-exercise-result" style="display: none; margin-top: 16px;"></div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer>
            <div class="setting-btn">
                <iconify-icon icon="mdi:cog" width="20" height="20"></iconify-icon>
                <span>ç³»ç»Ÿè®¾ç½®</span>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // åˆ‡æ¢é€‰é¡¹å¡
            const tabBtns = document.querySelectorAll('.tab-btn');
            const modules = document.querySelectorAll('.module');

            tabBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
                    tabBtns.forEach(b => b.classList.remove('active'));
                    modules.forEach(m => m.classList.remove('active'));

                    // æ·»åŠ å½“å‰æ¿€æ´»çŠ¶æ€
                    btn.classList.add('active');
                    const targetModule = document.getElementById(btn.dataset.target);
                    if (targetModule) {
                        targetModule.classList.add('active');
                    }
                });
            });

            // é»˜è®¤æ¿€æ´»ç¬¬ä¸€ä¸ªé€‰é¡¹å¡
            if (tabBtns.length > 0) {
                tabBtns[0].click();
            }

            // åˆå§‹åŒ–æ³¢å½¢å›¾
            function initWaveform() {
                const chartDom = document.getElementById('waveform');
                if (!chartDom) return;
                
                const myChart = echarts.init(chartDom);
                
                // ç”Ÿæˆæ¨¡æ‹Ÿå½•éŸ³æ³¢å½¢æ•°æ®
                const data = Array.from({length: 200}, () => Math.random() * 50);
                
                const option = {
                    grid: {
                        top: 10,
                        bottom: 10,
                        left: 0,
                        right: 0
                    },
                    xAxis: {
                        type: 'category',
                        show: false
                    },
                    yAxis: {
                        type: 'value',
                        show: false
                    },
                    series: [
                        {
                            name: 'éŸ³é¢‘æ³¢å½¢',
                            type: 'line',
                            showSymbol: false,
                            data: data,
                            areaStyle: {
                                color: {
                                    type: 'linear',
                                    x: 0,
                                    y: 0,
                                    x2: 0,
                                    y2: 1,
                                    colorStops: [
                                        {offset: 0, color: 'rgba(58, 134, 255, 0.3)'},
                                        {offset: 1, color: 'rgba(58, 134, 255, 0.05)'}
                                    ]
                                }
                            },
                            lineStyle: {
                                width: 1.5,
                                color: '#3A86FF'
                            }
                        }
                    ]
                };
                
                myChart.setOption(option);
            }

            // åˆå§‹åŒ–è¯„åˆ†ä»ªè¡¨ç›˜ï¼Œå¹¶æš´éœ²å¯æ›´æ–°çš„å‡½æ•°
            let scoreChart = null;
            function initDashboard() {
                const chartDom = document.getElementById('score-dashboard');
                if (!chartDom) return;
                scoreChart = echarts.init(chartDom);

                const option = {
                    tooltip: { formatter: '{a} : {c}' },
                    series: [{
                        name: 'å‘éŸ³è¯„åˆ†',
                        type: 'gauge',
                        startAngle: 180,
                        endAngle: 0,
                        min: 0,
                        max: 100,
                        radius: '100%',
                        center: ['50%', '60%'],
                        splitNumber: 10,
                        axisLine: { lineStyle: { width: 10, color: [[0.6,'#FFD166'],[0.8,'#3A86FF'],[1,'#52B788']] } },
                        pointer: { icon: 'path://M12.8,0.7l12,40.1H0.7L12.8,0.7z', length: '12%', width: 10, offsetCenter: [0,'-60%'], itemStyle: { color: '#495057' } },
                        axisTick: { length: 8, lineStyle: { color: 'auto', width: 1 } },
                        splitLine: { length: 12, lineStyle: { color: 'auto', width: 2 } },
                        axisLabel: { distance: -20, color: '#868E96', fontSize: 12 },
                        title: { offsetCenter: [0,'-5%'], fontSize: 12, color: '#868E96' },
                        detail: { valueAnimation: true, fontSize: 24, offsetCenter: [0,'30%'], fontWeight: 600, formatter: v => v + 'åˆ†', color: 'inherit' },
                        data: [{ value: 0, name: 'å¾—åˆ†' }]
                    }]
                };
                scoreChart.setOption(option);
            }

            function updateScoreDashboard(value) {
                if (!scoreChart) return;
                const v = Math.max(0, Math.min(100, Number(value) || 0));
                scoreChart.setOption({ series: [{ data: [{ value: v, name: 'å¾—åˆ†' }] }] });
            }

            initDashboard();

            // è¯­éŸ³è¯„åˆ†æ¨¡å—
            const speechModule = document.getElementById('speech');
            if (speechModule) {
                const getSentenceBtn = speechModule.querySelector('.generate-sentence-btn');
                const sentenceDisplay = speechModule.querySelector('.sentence-box');
                const recordBtn = speechModule.querySelector('.rec-btn');
                const scoreDisplay = speechModule.querySelector('.score-display');
                const timerDisplay = speechModule.querySelector('.timer');
                const useSimpleScoringCheckbox = speechModule.querySelector('#useSimpleScoring');
                const useDetailedScoringCheckbox = speechModule.querySelector('#useDetailedScoring');

                let currentSentence = '';
                let audioBlob = null;
                let isSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true; // é»˜è®¤ä½¿ç”¨ç®€åŒ–æ¨¡å¼
                let isDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false; // é»˜è®¤ä¸ä½¿ç”¨è¯¦ç»†åˆ†æ

                // æ·»åŠ è¯„åˆ†æ¨¡å¼åˆ‡æ¢ç›‘å¬å™¨
                if (useSimpleScoringCheckbox) {
                    useSimpleScoringCheckbox.addEventListener('change', function() {
                        isSimpleScoring = this.checked;
                        console.log(`ç®€åŒ–è¯„åˆ†æ¨¡å¼: ${isSimpleScoring ? 'å¼€å¯' : 'å…³é—­'}`);
                        
                        if (isSimpleScoring) {
                            // åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼æ—¶ï¼Œé‡ç½®è¯„åˆ†æ˜¾ç¤º
                            scoreDisplay.textContent = '0';
                            scoreDisplay.style.color = '#3A86FF';
                            document.querySelector('.score-rating').textContent = 'æœªè¯„åˆ†';
                            clearDetailedResults();
                        }
                    });
                }
                
                if (useDetailedScoringCheckbox) {
                    useDetailedScoringCheckbox.addEventListener('change', function() {
                        isDetailedScoring = this.checked;
                        console.log(`è¯¦ç»†è¯„åˆ†æ¨¡å¼: ${isDetailedScoring ? 'å¼€å¯' : 'å…³é—­'}`);
                        
                        if (!isDetailedScoring) {
                            clearDetailedResults();
                        }
                    });
                }

                // æ¸…ç†è¯¦ç»†ç»“æœæ˜¾ç¤º
                function clearDetailedResults() {
                    const detailedResultsContainer = document.getElementById('detailed-results');
                    if (detailedResultsContainer) {
                        detailedResultsContainer.remove();
                    }
                }

                // æ˜¾ç¤ºè¯¦ç»†è¯„åˆ†ç»“æœ
                function displayDetailedResults(result) {
                    // æ¸…ç†ä¹‹å‰çš„ç»“æœ
                    clearDetailedResults();
                    
                    // åˆ›å»ºè¯¦ç»†ç»“æœå®¹å™¨
                    const detailedContainer = document.createElement('div');
                    detailedContainer.id = 'detailed-results';
                    detailedContainer.style.cssText = `
                        margin-top: 24px; 
                        padding: 16px; 
                        background: #F8F9FA; 
                        border-radius: 8px; 
                        border: 1px solid #E9ECEF;
                        max-height: 500px;
                        overflow-y: auto;
                    `;
                    
                    let detailedHTML = `
                        <h4 style="margin-bottom: 16px; color: #495057; font-size: 1.1rem;">ğŸ” è¯¦ç»†åˆ†æç»“æœ</h4>
                    `;
                    
                    // æ˜¾ç¤ºå•è¯çº§è¯„åˆ†å’Œå»ºè®®ï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
                    if (result.word_scores && result.word_scores.length > 0) {
                        // ç­›é€‰éœ€è¦æ”¹è¿›çš„å•è¯
                        const wordsNeedingImprovement = result.word_scores.filter(ws => ws.needs_improvement);
                        
                        if (wordsNeedingImprovement.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 20px; padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                    <h5 style="margin-bottom: 12px; color: #E63946; font-size: 1rem;">ğŸ¯ éœ€è¦é‡ç‚¹æ”¹è¿›çš„å•è¯:</h5>
                            `;
                            
                            wordsNeedingImprovement.forEach(wordInfo => {
                                const qualityColor = {
                                    'excellent': '#52B788',
                                    'good': '#3A86FF', 
                                    'fair': '#FFD166',
                                    'poor': '#E63946',
                                    'unknown': '#868E96'
                                }[wordInfo.quality] || '#868E96';
                                
                                const qualityText = {
                                    'excellent': 'ä¼˜ç§€',
                                    'good': 'è‰¯å¥½', 
                                    'fair': 'ä¸€èˆ¬',
                                    'poor': 'è¾ƒå·®',
                                    'unknown': 'æœªçŸ¥'
                                }[wordInfo.quality] || 'æœªçŸ¥';
                                
                                detailedHTML += `
                                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #E9ECEF;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <strong style="color: #495057; font-size: 1rem;">'${wordInfo.word}'</strong>
                                            <span style="
                                                padding: 3px 8px; 
                                                background: ${qualityColor}; 
                                                color: white; 
                                                border-radius: 12px; 
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                            ">${wordInfo.score.toFixed(1)}åˆ† (${qualityText})</span>
                                        </div>
                                `;
                                
                                // æ˜¾ç¤ºè¯¥å•è¯çš„å…·ä½“å»ºè®®
                                if (wordInfo.suggestions && wordInfo.suggestions.length > 0) {
                                    detailedHTML += `
                                        <div style="margin-left: 16px;">
                                            <p style="font-size: 0.9rem; color: #495057; margin-bottom: 4px; font-weight: 600;">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                            <ul style="margin-left: 16px; margin-bottom: 8px;">
                                    `;
                                    wordInfo.suggestions.forEach(suggestion => {
                                        detailedHTML += `<li style="color: #495057; font-size: 0.85rem; margin-bottom: 2px;">${suggestion}</li>`;
                                    });
                                    detailedHTML += `</ul>`;
                                }
                                
                                // æ˜¾ç¤ºéŸ³ç´ çº§è¯¦æƒ…ï¼ˆå¯å±•å¼€ï¼‰
                                if (wordInfo.phoneme_scores && wordInfo.phoneme_scores.length > 0) {
                                    detailedHTML += `
                                        <details style="margin-left: 16px;">
                                            <summary style="cursor: pointer; color: #3A86FF; font-size: 0.85rem;">ğŸ“Š æŸ¥çœ‹éŸ³ç´ è¯¦æƒ…</summary>
                                            <div style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 4px;">
                                    `;
                                    wordInfo.phoneme_scores.forEach(ps => {
                                        const phonemeColor = {
                                            'excellent': '#52B788',
                                            'good': '#3A86FF',
                                            'fair': '#FFD166',
                                            'poor': '#E63946'
                                        }[ps.quality] || '#868E96';
                                        
                                        detailedHTML += `
                                            <span style="
                                                display: inline-block;
                                                padding: 2px 6px;
                                                background: ${phonemeColor};
                                                color: white;
                                                border-radius: 3px;
                                                font-size: 0.75rem;
                                                margin: 1px;
                                            " title="è¯„åˆ†: ${ps.score.toFixed(1)}">
                                                ${ps.phoneme} (${ps.score.toFixed(0)})
                                            </span>
                                        `;
                                    });
                                    detailedHTML += `
                                            </div>
                                        </details>
                                    `;
                                }
                                
                                detailedHTML += `</div>`;
                            });
                            
                            detailedHTML += `</div>`;
                        }
                        
                        // æ˜¾ç¤ºè¡¨ç°è‰¯å¥½çš„å•è¯ï¼ˆé¼“åŠ±ï¼‰
                        const goodWords = result.word_scores.filter(ws => !ws.needs_improvement && ws.score > 0);
                        if (goodWords.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 16px; padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                    <h5 style="margin-bottom: 8px; color: #52B788; font-size: 0.95rem;">ğŸŒŸ å‘éŸ³è‰¯å¥½çš„å•è¯:</h5>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            `;
                            goodWords.forEach(wordInfo => {
                                detailedHTML += `
                                    <span style="
                                        padding: 4px 8px;
                                        background: #52B788;
                                        color: white;
                                        border-radius: 12px;
                                        font-size: 0.85rem;
                                        font-weight: 500;
                                    ">'${wordInfo.word}' (${wordInfo.score.toFixed(1)})</span>
                                `;
                            });
                            detailedHTML += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // æ˜¾ç¤ºéŸ³ç´ çº§è¯„åˆ†ï¼ˆæŠ˜å æ˜¾ç¤ºï¼Œé¿å…è¿‡äºå†—é•¿ï¼‰
                    if (result.phoneme_scores && result.phoneme_scores.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #3A86FF; font-weight: 600; margin-bottom: 8px;">ğŸ”Š æŸ¥çœ‹å®Œæ•´éŸ³ç´ åˆ†æ (${result.phoneme_scores.length}ä¸ªéŸ³ç´ )</summary>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; background: white; border-radius: 4px;">
                        `;
                        
                        result.phoneme_scores.forEach(ps => {
                            let bgColor = '#52B788';  // ç»¿è‰²ï¼ˆä¼˜ç§€ï¼‰
                            if (ps.quality === 'good') bgColor = '#3A86FF';      // è“è‰²ï¼ˆè‰¯å¥½ï¼‰
                            else if (ps.quality === 'fair') bgColor = '#FFD166';  // é»„è‰²ï¼ˆä¸€èˆ¬ï¼‰
                            else if (ps.quality === 'poor') bgColor = '#E63946';  // çº¢è‰²ï¼ˆè¾ƒå·®ï¼‰
                            
                            detailedHTML += `
                                <span style="
                                    display: inline-block; 
                                    padding: 4px 8px; 
                                    margin: 2px; 
                                    background: ${bgColor};
                                    color: white; 
                                    border-radius: 4px; 
                                    font-size: 0.9rem;
                                    cursor: pointer;
                                " title="è¯„åˆ†: ${ps.score.toFixed(1)}, æ—¶é—´: ${ps.start_time.toFixed(2)}s-${ps.end_time.toFixed(2)}s">
                                    ${ps.phoneme} (${ps.score.toFixed(0)})
                                </span>
                            `;
                        });
                        
                        detailedHTML += `
                                </div>
                                <p style="font-size: 0.8rem; color: #868E96; margin-top: 8px;">
                                    é¢œè‰²è¯´æ˜: <span style="color: #52B788;">â–ˆ ä¼˜ç§€</span> 
                                    <span style="color: #3A86FF;">â–ˆ è‰¯å¥½</span> 
                                    <span style="color: #FFD166;">â–ˆ ä¸€èˆ¬</span> 
                                    <span style="color: #E63946;">â–ˆ éœ€æ”¹è¿›</span>
                                </p>
                            </details>
                        `;
                    }
                    
                    // æ˜¾ç¤ºå‘ç°çš„é—®é¢˜ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (result.pronunciation_issues && result.pronunciation_issues.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #E63946; font-weight: 600;">âš ï¸ å‘ç°çš„æŠ€æœ¯é—®é¢˜ (${result.pronunciation_issues.length}é¡¹)</summary>
                                <ul style="margin-left: 16px; color: #495057; margin-top: 8px;">
                        `;
                        result.pronunciation_issues.forEach(issue => {
                            detailedHTML += `<li style="margin-bottom: 4px; font-size: 0.9rem;">${issue}</li>`;
                        });
                        detailedHTML += `</ul></details>`;
                    }
                    
                    // æ˜¾ç¤ºæ”¹è¿›å»ºè®®ï¼ˆé‡è¦ï¼Œå§‹ç»ˆå±•å¼€ï¼‰
                    if (result.improvement_suggestions && result.improvement_suggestions.length > 0) {
                        detailedHTML += `
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F4FF; border-left: 4px solid #3A86FF; border-radius: 4px;">
                                <h5 style="margin-bottom: 8px; color: #3A86FF; font-weight: 600;">ğŸ’¡ ç»¼åˆæ”¹è¿›å»ºè®®:</h5>
                                <div style="color: #495057; line-height: 1.5;">
                        `;
                        result.improvement_suggestions.forEach(suggestion => {
                            // æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡é¢˜è¡Œï¼ˆåŒ…å«emojiæˆ–ç‰¹æ®Šå­—ç¬¦ï¼‰
                            if (suggestion.match(/^[\u{1F300}-\u{1F9FF}]|^\s*[\u2022\u2023\u25E6\u2043\u2219]/u) || 
                                suggestion.includes(':')) {
                                detailedHTML += `<p style="font-weight: 600; margin: 8px 0 4px 0; color: #3A86FF;">${suggestion}</p>`;
                            } else {
                                detailedHTML += `<p style="margin: 4px 0; padding-left: 12px;">${suggestion}</p>`;
                            }
                        });
                        detailedHTML += `</div></div>`;
                    }
                    
                    // æ˜¾ç¤ºç»ƒä¹ ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰ï¼‰
                    if (result.duration_analysis) {
                        detailedHTML += `
                            <details style="margin-bottom: 8px;">
                                <summary style="cursor: pointer; color: #868E96; font-size: 0.9rem;">ğŸ“Š è¯­éŸ³åˆ†ææ•°æ®</summary>
                                <div style="font-size: 0.8rem; color: #495057; margin-top: 8px;">
                                    <p>æ€»æ—¶é•¿: ${result.duration_analysis.total_duration?.toFixed(2) || 'æœªçŸ¥'}ç§’</p>
                                    <p>è¯­é€Ÿ: ${result.duration_analysis.speech_rate?.toFixed(1) || 'æœªçŸ¥'} éŸ³ç´ /ç§’</p>
                                    <p>å¹³å‡éŸ³ç´ æ—¶é•¿: ${result.duration_analysis.avg_phoneme_duration?.toFixed(3) || 'æœªçŸ¥'}ç§’</p>
                                </div>
                            </details>
                        `;
                    }
                    
                    detailedContainer.innerHTML = detailedHTML;
                    
                    // å°†è¯¦ç»†ç»“æœæ·»åŠ åˆ°å³ä¾§é¢æ¿
                    const dashboard = speechModule.querySelector('.dashboard');
                    if (dashboard) {
                        dashboard.appendChild(detailedContainer);
                    }
                }
                getSentenceBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-english-sentence');
                        currentSentence = response.data.sentence;
                        sentenceDisplay.textContent = currentSentence;
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = 'æœªè¯„åˆ†';
                        updateScoreDashboard(0);
                    } catch (error) {
                        console.error('è·å–å¥å­å¤±è´¥:', error);
                        alert('è·å–å¥å­å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });

                // å½•éŸ³åŠŸèƒ½å®ç°
                let mediaRecorder;
                let audioChunks = [];
                let recordingTimer;
                let seconds = 0;
                let minutes = 0;

                // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
                function formatTime() {
                    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }

                // æ›´æ–°è®¡æ—¶å™¨
                function updateTimer() {
                    seconds++;
                    if (seconds >= 60) {
                        seconds = 0;
                        minutes++;
                    }
                    timerDisplay.textContent = formatTime();
                }

                // å¼€å§‹å½•éŸ³
                async function startRecording() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = event => {
                            if (event.data.size > 0) {
                                audioChunks.push(event.data);
                            }
                        };

                        mediaRecorder.onstop = () => {
                            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                            stream.getTracks().forEach(track => track.stop());
                            alert('å½•éŸ³å®Œæˆ');
                            initWaveform(); // æ›´æ–°æ³¢å½¢å›¾
                        };

                        mediaRecorder.start();
                        seconds = 0;
                        minutes = 0;
                        timerDisplay.textContent = formatTime();
                        recordingTimer = setInterval(updateTimer, 1000);
                    } catch (error) {
                        console.error('å½•éŸ³æƒé™è¯·æ±‚å¤±è´¥:', error);
                        alert('æ— æ³•è®¿é—®éº¦å…‹é£ã€‚è¯·ç¡®ä¿å·²æˆäºˆéº¦å…‹é£æƒé™å¹¶å°è¯•å†æ¬¡å½•éŸ³ã€‚');
                        recorder.classList.remove('recording');
                    }
                }

                // åœæ­¢å½•éŸ³
                function stopRecording() {
                    if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                        mediaRecorder.stop();
                        clearInterval(recordingTimer);
                    }
                }

                // å½•éŸ³æŒ‰é’®çŠ¶æ€åˆ‡æ¢
                recordBtn.addEventListener('click', () => {
                    // ç¡®ä¿æœ‰å¥å­æ‰èƒ½å½•éŸ³
                    if (!currentSentence) {
                        alert('è¯·å…ˆç‚¹å‡»"ç”Ÿæˆæ–°å¥å­"æŒ‰é’®è·å–å¥å­');
                        return;
                    }

                    const recorder = recordBtn.closest('.recorder');
                    recorder.classList.toggle('recording');

                    if (recorder.classList.contains('recording')) {
                        startRecording();
                    } else {
                        stopRecording();
                        timerDisplay.textContent = '00:00';
                    }
                });

                // æ·»åŠ æäº¤è¯„åˆ†æŒ‰é’®äº‹ä»¶
                const submitScoreBtn = document.createElement('button');
                submitScoreBtn.textContent = 'æäº¤è¯„åˆ†';
                submitScoreBtn.style.cssText = 'background: #3A86FF; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; margin-top: 16px;';
                speechModule.querySelector('.panel').appendChild(submitScoreBtn);

                // æäº¤è¯„åˆ†
                submitScoreBtn.addEventListener('click', async () => {
                    if (!currentSentence || !audioBlob) {
                        alert('è¯·å…ˆè·å–å¥å­å¹¶å®Œæˆå½•éŸ³');
                        return;
                    }

                    try {
                        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                        submitScoreBtn.textContent = 'è¯„åˆ†ä¸­...';
                        submitScoreBtn.disabled = true;
                        
                        // æ¸…ç†ä¹‹å‰çš„è¯¦ç»†ç»“æœ
                        clearDetailedResults();
                        
                        // æ£€æŸ¥ç”¨æˆ·é€‰æ‹©çš„è¯„åˆ†æ¨¡å¼
                        const useSimpleScoring = useSimpleScoringCheckbox ? useSimpleScoringCheckbox.checked : true;
                        const useDetailedScoring = useDetailedScoringCheckbox ? useDetailedScoringCheckbox.checked : false;
                        
                        let apiEndpoint;
                        let modeText;
                        
                        if (useDetailedScoring) {
                            apiEndpoint = '/api/score-pronunciation-detailed';
                            modeText = 'éŸ³ç´ çº§è¯¦ç»†æ¨¡å¼';
                        } else if (useSimpleScoring) {
                            apiEndpoint = '/api/score-pronunciation-simple';
                            modeText = 'ç®€åŒ–æ¨¡å¼';
                        } else {
                            apiEndpoint = '/api/score-pronunciation';
                            modeText = 'å®Œæ•´æ¨¡å¼';
                        }
                        
                        console.log(`ä½¿ç”¨${modeText}ï¼Œæ¥å£: ${apiEndpoint}`);
                        
                        const formData = new FormData();
                        formData.append('reference_text', currentSentence);
                        formData.append('audio_file', audioBlob, 'recording.webm');

                        console.log('æ­£åœ¨æäº¤è¯„åˆ†è¯·æ±‚...');
                        const response = await axios.post(apiEndpoint, formData);
                        console.log('è¯„åˆ†å“åº”:', response.data);
                        
                        if (response.data.error) {
                            throw new Error(response.data.error);
                        }
                        
                        // å¤„ç†ä¸åŒç±»å‹çš„è¯„åˆ†ç»“æœ
                        let score, detailedResult = null;
                        
                        if (useDetailedScoring && response.data.overall_score !== undefined) {
                            // è¯¦ç»†è¯„åˆ†ç»“æœ
                            score = response.data.overall_score;
                            detailedResult = response.data;
                        } else {
                            // ç®€å•è¯„åˆ†ç»“æœ
                            score = response.data.score;
                        }
                        
                        // æ›´æ–°è¯„åˆ†æ˜¾ç¤º
                        scoreDisplay.textContent = score;
                        updateScoreDashboard(score);
                        
                        // æ›´æ–°è¯„åˆ†ç­‰çº§
                        const scoreNum = parseFloat(score);
                        if (scoreNum >= 90) {
                            document.querySelector('.score-rating').textContent = 'ä¼˜ç§€';
                            scoreDisplay.style.color = '#52B788';
                        } else if (scoreNum >= 75) {
                            document.querySelector('.score-rating').textContent = 'è‰¯å¥½';
                            scoreDisplay.style.color = '#3A86FF';
                        } else if (scoreNum >= 60) {
                            document.querySelector('.score-rating').textContent = 'åŠæ ¼';
                            scoreDisplay.style.color = '#FFD166';
                        } else {
                            document.querySelector('.score-rating').textContent = 'éœ€è¦æ”¹è¿›';
                            scoreDisplay.style.color = '#E63946';
                        }
                        
                        // æ˜¾ç¤ºè¯¦ç»†ç»“æœï¼ˆå¦‚æœæœ‰ï¼‰
                        if (detailedResult && detailedResult.detailed !== false) {
                            displayDetailedResults(detailedResult);
                            alert(`è¯„åˆ†å®Œæˆï¼æ‚¨çš„å¾—åˆ†æ˜¯ï¼š${score}åˆ†\nï¼ˆä½¿ç”¨${modeText}ï¼‰\nè¯·æŸ¥çœ‹ä¸‹æ–¹çš„è¯¦ç»†åˆ†æç»“æœ`);
                        } else {
                            // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                            alert(`è¯„åˆ†å®Œæˆï¼æ‚¨çš„å¾—åˆ†æ˜¯ï¼š${score}åˆ†\nï¼ˆä½¿ç”¨${modeText}ï¼‰`);
                        }
                        
                    } catch (error) {
                        console.error('è¯„åˆ†å¤±è´¥:', error);
                        
                        let errorMessage = 'è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•';
                        if (error.response && error.response.data && error.response.data.error) {
                            errorMessage = `è¯„åˆ†å¤±è´¥ï¼š${error.response.data.error}`;
                        } else if (error.message) {
                            errorMessage = `è¯„åˆ†å¤±è´¥ï¼š${error.message}`;
                        }
                        
                        alert(errorMessage);
                        
                        // å¦‚æœå®Œæ•´æ¨¡å¼å¤±è´¥ï¼Œå»ºè®®ç”¨æˆ·åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼
                        if (!useSimpleScoringCheckbox.checked && !useDetailedScoringCheckbox.checked) {
                            if (confirm('å®Œæ•´è¯„åˆ†æ¨¡å¼å¤±è´¥ï¼Œæ˜¯å¦åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼é‡è¯•ï¼Ÿ')) {
                                useSimpleScoringCheckbox.checked = true;
                                alert('å·²åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼ï¼Œè¯·é‡æ–°ç‚¹å‡»"æäº¤è¯„åˆ†"æŒ‰é’®');
                            }
                        }
                        
                        // é‡ç½®è¯„åˆ†æ˜¾ç¤º
                        scoreDisplay.textContent = '0';
                        scoreDisplay.style.color = '#3A86FF';
                        document.querySelector('.score-rating').textContent = 'è¯„åˆ†å¤±è´¥';
                    } finally {
                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                        submitScoreBtn.textContent = 'æäº¤è¯„åˆ†';
                        submitScoreBtn.disabled = false;
                    }
                });
            }

            // è¯­æ³•æ£€æµ‹æ¨¡å—
            const grammarModule = document.getElementById('grammar');
            if (grammarModule) {
                const getChineseBtn = grammarModule.querySelector('.generate-sentence-btn');
                const chineseDisplay = grammarModule.querySelector('.sentence-box');
                const translatedInput = grammarModule.querySelector('#grammar-text-input');
                const recordGrammarBtn = grammarModule.querySelector('.rec-btn');
                const errorTextDisplay = grammarModule.querySelector('.error-text');
                
                // è¯­éŸ³è¾“å…¥ç›¸å…³å…ƒç´ 
                const voiceInputToggle = document.getElementById('voice-input-toggle');
                const voiceInputControls = document.getElementById('voice-input-controls');
                const voiceRecordBtn = document.getElementById('voice-record-btn');

                let currentChinese = '';
                let grammarMediaRecorder = null;
                let grammarChunks = [];
                let grammarAudioBlob = null;
                
                // è¯­éŸ³è¾“å…¥çŠ¶æ€
                let isVoiceInputMode = false;
                let voiceRecorder = null;
                let voiceChunks = [];
                let isVoiceRecording = false;
                
                // è¯­éŸ³è¾“å…¥åˆ‡æ¢äº‹ä»¶
                if (voiceInputToggle) {
                    voiceInputToggle.addEventListener('change', function() {
                        isVoiceInputMode = this.checked;
                        
                        if (isVoiceInputMode) {
                            // å¯ç”¨è¯­éŸ³è¾“å…¥æ¨¡å¼
                            translatedInput.disabled = true;
                            translatedInput.placeholder = 'è¯­éŸ³è¾“å…¥æ¨¡å¼å·²å¯ç”¨ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹å½•éŸ³æŒ‰é’®è¿›è¡Œè¯­éŸ³è¾“å…¥';
                            translatedInput.style.background = '#F8F9FA';
                            voiceInputControls.style.display = 'block';
                        } else {
                            // ç¦ç”¨è¯­éŸ³è¾“å…¥æ¨¡å¼
                            translatedInput.disabled = false;
                            translatedInput.placeholder = 'åœ¨æ­¤è¾“å…¥æ‚¨çš„è‹±æ–‡æ–‡æœ¬...';
                            translatedInput.style.background = 'white';
                            voiceInputControls.style.display = 'none';
                            // åœæ­¢æ­£åœ¨è¿›è¡Œçš„å½•éŸ³
                            if (isVoiceRecording && voiceRecorder) {
                                voiceRecorder.stop();
                            }
                        }
                    });
                }
                
                // è¯­éŸ³å½•éŸ³åŠŸèƒ½
                if (voiceRecordBtn) {
                    voiceRecordBtn.addEventListener('click', async function() {
                        if (!isVoiceRecording) {
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                voiceChunks = [];
                                voiceRecorder = new MediaRecorder(stream);
                                
                                voiceRecorder.ondataavailable = (e) => {
                                    if (e.data.size > 0) voiceChunks.push(e.data);
                                };
                                
                                voiceRecorder.onstop = async () => {
                                    const audioBlob = new Blob(voiceChunks, { type: 'audio/webm' });
                                    stream.getTracks().forEach(t => t.stop());
                                    isVoiceRecording = false;
                                    
                                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                                    voiceRecordBtn.innerHTML = `
                                        <iconify-icon icon="mdi:loading" width="20" height="20" class="animate-spin"></iconify-icon>
                                        <span>è¯†åˆ«ä¸­...</span>
                                    `;
                                    voiceRecordBtn.disabled = true;
                                    
                                    try {
                                        // è°ƒç”¨Whisper APIè¿›è¡Œè¯­éŸ³è¯†åˆ«
                                        await processVoiceInput(audioBlob);
                                    } catch (error) {
                                        console.error('è¯­éŸ³è¯†åˆ«å¤±è´¥:', error);
                                        alert('è¯­éŸ³è¯†åˆ«å¤±è´¥ï¼Œè¯·é‡è¯•');
                                    } finally {
                                        // æ¢å¤æŒ‰é’®çŠ¶æ€
                                        voiceRecordBtn.innerHTML = `
                                            <iconify-icon icon="mdi:microphone" width="20" height="20"></iconify-icon>
                                            <span>å¼€å§‹å½•éŸ³</span>
                                        `;
                                        voiceRecordBtn.disabled = false;
                                    }
                                };
                                
                                voiceRecorder.start();
                                isVoiceRecording = true;
                                
                                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                                voiceRecordBtn.innerHTML = `
                                    <iconify-icon icon="mdi:stop" width="20" height="20"></iconify-icon>
                                    <span>åœæ­¢å½•éŸ³</span>
                                `;
                                voiceRecordBtn.style.background = '#E63946';
                                
                            } catch (error) {
                                console.error('å½•éŸ³æƒé™è¯·æ±‚å¤±è´¥:', error);
                                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                            }
                        } else {
                            // åœæ­¢å½•éŸ³
                            if (voiceRecorder && voiceRecorder.state !== 'inactive') {
                                voiceRecorder.stop();
                            }
                        }
                    });
                }
                
                // å¤„ç†è¯­éŸ³è¾“å…¥çš„å‡½æ•°
                async function processVoiceInput(audioBlob) {
                    try {
                        const formData = new FormData();
                        formData.append('audio_file', audioBlob, 'voice_input.webm');
                        
                        const response = await axios.post('/api/transcribe-audio', formData);
                        
                        if (response.data.error) {
                            throw new Error(response.data.error);
                        }
                        
                        const transcribedText = response.data.transcribed_text || '';
                        
                        if (transcribedText.trim()) {
                            // å°†è¯†åˆ«çš„æ–‡æœ¬å¡«å…¥æ–‡æœ¬æ¡†
                            translatedInput.value = transcribedText;
                            
                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            const successMsg = document.createElement('div');
                            successMsg.style.cssText = `
                                position: fixed;
                                top: 20px;
                                right: 20px;
                                background: #52B788;
                                color: white;
                                padding: 12px 20px;
                                border-radius: 6px;
                                font-size: 0.9rem;
                                z-index: 1000;
                                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                            `;
                            successMsg.textContent = `âœ… è¯­éŸ³è¯†åˆ«æˆåŠŸ: "${transcribedText}"`;
                            document.body.appendChild(successMsg);
                            
                            // 3ç§’åç§»é™¤æç¤º
                            setTimeout(() => {
                                if (successMsg.parentNode) {
                                    successMsg.parentNode.removeChild(successMsg);
                                }
                            }, 3000);
                            
                        } else {
                            alert('æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„è¯­éŸ³å†…å®¹ï¼Œè¯·é‡æ–°å½•éŸ³');
                        }
                        
                    } catch (error) {
                        console.error('è¯­éŸ³è¯†åˆ«å¤„ç†å¤±è´¥:', error);
                        throw error;
                    }
                }

                // è·å–éšæœºä¸­æ–‡å¥å­
                getChineseBtn.addEventListener('click', async () => {
                    try {
                        const response = await axios.get('/api/random-chinese-sentence');
                        currentChinese = response.data.sentence;
                        chineseDisplay.textContent = currentChinese;
                        translatedInput.value = '';
                        errorTextDisplay.innerHTML = '<p>è¯·è¾“å…¥è‹±æ–‡ç¿»è¯‘ï¼ˆå¯é€‰å½•éŸ³ï¼‰...</p>';
                        grammarAudioBlob = null;
                    } catch (error) {
                        console.error('è·å–ä¸­æ–‡å¥å­å¤±è´¥:', error);
                        alert('è·å–ä¸­æ–‡å¥å­å¤±è´¥ï¼Œè¯·é‡è¯•');
                    }
                });

                // å½•éŸ³åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
                if (recordGrammarBtn) {
                    recordGrammarBtn.addEventListener('click', async () => {
                        if (!currentChinese) {
                            alert('è¯·å…ˆè·å–ä¸­æ–‡å¥å­');
                            return;
                        }

                        const container = recordGrammarBtn.closest('.panel');
                        container.classList.toggle('recording');

                        try {
                            if (container.classList.contains('recording')) {
                                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                grammarChunks = [];
                                grammarMediaRecorder = new MediaRecorder(stream);
                                grammarMediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) grammarChunks.push(e.data); };
                                grammarMediaRecorder.onstop = () => {
                                    grammarAudioBlob = new Blob(grammarChunks, { type: 'audio/webm' });
                                    stream.getTracks().forEach(t => t.stop());
                                    alert('å½•éŸ³å®Œæˆ');
                                };
                                grammarMediaRecorder.start();
                            } else {
                                if (grammarMediaRecorder && grammarMediaRecorder.state !== 'inactive') {
                                    grammarMediaRecorder.stop();
                                }
                            }
                        } catch (err) {
                            console.error('å½•éŸ³å¤±è´¥:', err);
                            alert('æ— æ³•è®¿é—®éº¦å…‹é£');
                            container.classList.remove('recording');
                        }
                    });
                } else {
                    console.log('æœªæ‰¾åˆ°.rec-btnå…ƒç´ ï¼Œè·³è¿‡å½•éŸ³åŠŸèƒ½åˆå§‹åŒ–');
                }

                // æ·»åŠ æäº¤è¯­æ³•æ£€æµ‹æŒ‰é’®åŠŸèƒ½
                const submitGrammarCheckBtn = document.getElementById('submit-grammar-check');
                if (submitGrammarCheckBtn) {
                    console.log('æ‰¾åˆ°è¯­æ³•æ£€æµ‹æŒ‰é’®');
                    submitGrammarCheckBtn.addEventListener('click', async () => {
                        console.log('è¯­æ³•æ£€æµ‹æŒ‰é’®è¢«ç‚¹å‡»');
                        const textInput = translatedInput.value.trim();
                        
                        if (!textInput) {
                            alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„è‹±æ–‡æ–‡æœ¬');
                            return;
                        }

                        try {
                            submitGrammarCheckBtn.textContent = 'æ£€æµ‹ä¸­...';
                            submitGrammarCheckBtn.disabled = true;
                            
                            const formData = new FormData();
                            formData.append('text', textInput);
                            
                            console.log('å‘ /api/check-grammar-text å‘é€è¯·æ±‚ï¼Œæ–‡æœ¬å†…å®¹:', textInput);

                            const response = await axios.post('/api/check-grammar-text', formData);
                            console.log('æ”¶åˆ°å“åº”:', response.data);
                            const result = response.data;
                            
                            if (result.error) {
                                throw new Error(result.error);
                            }
                            
                            // æ˜¾ç¤ºæ£€æµ‹ç»“æœ
                            if (result.success === false && result.errors && result.errors.length > 0) {
                                let errorHtml = `<p style="color: #E63946; font-weight: 600; margin-bottom: 16px;">âŒ å‘ç° ${result.errors.length} å¤„è¯­æ³•é—®é¢˜:</p>`;
                                
                                result.errors.forEach((error, index) => {
                                    errorHtml += `
                                        <div style="margin-bottom: 16px; padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                            <div style="font-weight: 600; color: #E63946; margin-bottom: 8px;">é”™è¯¯ ${index + 1}: ${error.rule_id || 'è¯­æ³•é”™è¯¯'}</div>
                                            <div style="margin-bottom: 8px; color: #495057;">
                                                <strong>é—®é¢˜:</strong> ${error.message || error.original_message || 'è¯­æ³•ä¸æ­£ç¡®'}
                                            </div>
                                            <div style="margin-bottom: 8px; color: #495057;">
                                                <strong>ä¸Šä¸‹æ–‡:</strong> "${error.context || ''}"
                                            </div>
                                            <div style="color: #495057;">
                                                <strong>å»ºè®®ä¿®æ”¹:</strong> ${error.replacements && error.replacements.length > 0 ? error.replacements.join(', ') : 'æ— å…·ä½“å»ºè®®'}
                                            </div>
                                        </div>`;
                                });
                                
                                // å¦‚æœæœ‰ä¿®æ­£å»ºè®®
                                if (result.corrected_text && result.corrected_text !== textInput) {
                                    errorHtml += `
                                        <div style="margin-top: 16px; padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                            <div style="font-weight: 600; color: #52B788; margin-bottom: 8px;">âœ… å»ºè®®ä¿®æ­£:</div>
                                            <div style="color: #495057; font-style: italic; font-size: 1.05rem; line-height: 1.4; margin-bottom: 8px;">${result.corrected_text}</div>
                                            <button onclick="copyToClipboard('${result.corrected_text.replace(/'/g, "\\'").replace(/"/g, '\\"')}')" style="background: #52B788; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">ğŸ“‹ å¤åˆ¶ä¿®æ­£ç‰ˆæœ¬</button>
                                        </div>`;
                                }
                                
                                errorTextDisplay.innerHTML = errorHtml;
                            } else {
                                // æ²¡æœ‰å‘ç°é”™è¯¯
                                errorTextDisplay.innerHTML = `
                                    <div style="padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                        <div style="font-weight: 600; color: #52B788; margin-bottom: 8px;">âœ… è¯­æ³•æ£€æµ‹å®Œæˆ</div>
                                        <div style="color: #495057;">${result.message || 'æœªå‘ç°æ˜æ˜¾çš„è¯­æ³•é”™è¯¯ï¼Œæ‚¨çš„è‹±æ–‡è¡¨è¾¾å¾ˆå¥½ï¼'}</div>
                                    </div>`;
                            }
                            
                        } catch (error) {
                            console.error('è¯­æ³•æ£€æµ‹å¤±è´¥:', error);
                            
                            let errorMessage = 'è¯­æ³•æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•';
                            if (error.response && error.response.data && error.response.data.error) {
                                errorMessage = `æ£€æµ‹å¤±è´¥: ${error.response.data.error}`;
                            } else if (error.message) {
                                errorMessage = `æ£€æµ‹å¤±è´¥: ${error.message}`;
                            }
                            
                            alert(errorMessage);
                            
                            // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                            errorTextDisplay.innerHTML = `
                                <div style="padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                    <div style="font-weight: 600; color: #E63946; margin-bottom: 8px;">âŒ æ£€æµ‹å¤±è´¥</div>
                                    <div style="color: #495057;">${errorMessage}</div>
                                </div>`;
                        } finally {
                            // æ¢å¤æŒ‰é’®çŠ¶æ€
                            submitGrammarCheckBtn.innerHTML = `
                                <iconify-icon icon="mdi:check-circle" width="20" height="20"></iconify-icon>
                                <span>æäº¤æ£€æµ‹</span>
                            `;
                            submitGrammarCheckBtn.disabled = false;
                        }
                    });
                } else {
                    console.error('æœªæ‰¾åˆ°IDä¸ºsubmit-grammar-checkçš„æŒ‰é’®');
                }


            }

            // æ–‡ä»¶ä¸Šä¼ æ•ˆæœ
            const uploadArea = document.querySelector('.upload-area');
            if (uploadArea) {
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#3A86FF';
                    uploadArea.style.backgroundColor = '#F1F8FF';
                });
                
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = '#DEE2E6';
                    uploadArea.style.backgroundColor = 'white';
                });
            }

            // ================================
            // è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— - ä¿®å¤ç‰ˆæœ¬
            // ================================
            (function() {
                console.log('ğŸ”§ åˆå§‹åŒ–è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å— (ä¿®å¤ç‰ˆ)');
                const customModule = document.getElementById('custom');
                if (!customModule) {
                    console.error('âŒ æœªæ‰¾åˆ°è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å—å®¹å™¨');
                    return;
                }
                
                // DOMå…ƒç´ æ£€æŸ¥å’Œè·å–
                const exerciseSetSelect = customModule.querySelector('#practice-exercise-select');
                const createExerciseSetBtn = customModule.querySelector('#createExerciseSetBtn');
                const modeBtns = customModule.querySelectorAll('[data-mode]');
                const importTextArea = customModule.querySelector('#import-text-area');
                const exerciseNameInput = customModule.querySelector('#exercise-name-input');
                const importTextBtn = customModule.querySelector('#import-text-btn');
                const exerciseContent = customModule.querySelector('#custom-exercise-content');
                const voiceInputArea = customModule.querySelector('#custom-input-area');
                const textInputArea = customModule.querySelector('#custom-input-area');
                const resultArea = customModule.querySelector('#custom-exercise-result');
                const recordCustomBtn = customModule.querySelector('#record-custom-btn');
                const recordStatus = customModule.querySelector('#recordStatus');
                const recordProgress = customModule.querySelector('#recordProgress');
                const answerTextarea = customModule.querySelector('#custom-answer-input');
                const startPracticeBtn = customModule.querySelector('#start-custom-practice-btn');
                const submitAnswerBtn = customModule.querySelector('#submit-custom-answer-btn');
                const nextExerciseBtn = customModule.querySelector('#next-exercise-btn');
                const difficultySelect = customModule.querySelector('#difficulty-select');
                
                // è¿›åº¦æ˜¾ç¤ºå…ƒç´ 
                const progressPercent = customModule.querySelector('#progressPercent');
                const progressFill = customModule.querySelector('#progressFill');
                const totalItems = customModule.querySelector('#totalItems');
                const completedItems = customModule.querySelector('#completedItems');
                const avgScore = customModule.querySelector('#avgScore');
                
                // æ£€æŸ¥å…³é”®å…ƒç´ æ˜¯å¦å­˜åœ¨
                console.log('ğŸ“‹ DOMå…ƒç´ æ£€æŸ¥ç»“æœ:', {
                    exerciseSetSelect: !!exerciseSetSelect,
                    importTextBtn: !!importTextBtn,
                    startPracticeBtn: !!startPracticeBtn,
                    exerciseContent: !!exerciseContent
                });
                
                // çŠ¶æ€å˜é‡
                let currentExerciseSet = null;
                let currentExerciseItem = null;
                let currentPracticeMode = 'text';
                let customMediaRecorder = null;
                let customChunks = [];
                let customAudioBlob = null;
                let exerciseStartTime = null;
                
                // åŠ è½½ç»ƒä¹ é›†åˆ—è¡¨
                async function loadExerciseSets() {
                    console.log('ğŸ”„ å¼€å§‹åŠ è½½ç»ƒä¹ é›†åˆ—è¡¨...');
                    try {
                        const response = await axios.get('/api/exercise-sets');
                        console.log('ğŸ“¦ APIå“åº”:', response.data);
                        
                        const exerciseSets = response.data.exercise_sets || [];
                        console.log(`ğŸ“š æ‰¾åˆ° ${exerciseSets.length} ä¸ªç»ƒä¹ é›†`);
                        
                        if (exerciseSetSelect) {
                            exerciseSetSelect.innerHTML = '<option value="">é€‰æ‹©å·²æœ‰ç»ƒä¹ é›†...</option>';
                            exerciseSets.forEach(set => {
                                const option = document.createElement('option');
                                option.value = set.id;
                                option.textContent = `${set.name} (${set.stats.total_items}é¢˜)`;
                                exerciseSetSelect.appendChild(option);
                                console.log(`  â• æ·»åŠ ç»ƒä¹ é›†: ${set.name}`);
                            });
                        } else {
                            console.warn('âš ï¸ exerciseSetSelect å…ƒç´ ä¸å­˜åœ¨');
                        }
                        
                        return exerciseSets;
                        
                    } catch (error) {
                        console.error('âŒ åŠ è½½ç»ƒä¹ é›†å¤±è´¥:', error);
                        if (exerciseSetSelect) {
                            exerciseSetSelect.innerHTML = '<option value="">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</option>';
                        }
                        return [];
                    }
                }
                
                // åˆå§‹åŒ–åŠ è½½
                console.log('ğŸš€ å¯åŠ¨åˆå§‹åŠ è½½...');
                loadExerciseSets().then(exerciseSets => {
                    console.log(`âœ… åˆå§‹åŠ è½½å®Œæˆï¼Œå…± ${exerciseSets.length} ä¸ªç»ƒä¹ é›†`);
                });
                
                // åˆ›å»ºç»ƒä¹ é›†
                if (createExerciseSetBtn) {
                    createExerciseSetBtn.addEventListener('click', async () => {
                        const name = prompt('è¯·è¾“å…¥ç»ƒä¹ é›†åç§°:');
                        if (!name) return;
                        
                        try {
                            const response = await axios.post('/api/exercise-sets', { name, description: '', type: 'mixed' });
                            if (response.data.success) {
                                alert(response.data.message);
                                await loadExerciseSets();
                                if (exerciseSetSelect) {
                                    exerciseSetSelect.value = response.data.exercise_id;
                                    await onExerciseSetChange();
                                }
                            }
                        } catch (error) {
                            alert('åˆ›å»ºç»ƒä¹ é›†å¤±è´¥ï¼Œè¯·é‡è¯•');
                        }
                    });
                }
                
                // ç»ƒä¹ é›†åˆ‡æ¢
                async function onExerciseSetChange() {
                    const exerciseId = exerciseSetSelect ? exerciseSetSelect.value : null;
                    if (!exerciseId) {
                        currentExerciseSet = null;
                        updateProgressDisplay();
                        return;
                    }
                    
                    try {
                        const response = await axios.get(`/api/exercise-sets/${exerciseId}`);
                        currentExerciseSet = response.data;
                        updateProgressDisplay();
                        resetExerciseArea();
                    } catch (error) {
                        alert('åŠ è½½ç»ƒä¹ é›†å¤±è´¥');
                    }
                }
                
                if (exerciseSetSelect) {
                    exerciseSetSelect.addEventListener('change', onExerciseSetChange);
                }
                
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                function updateProgressDisplay() {
                    if (!currentExerciseSet) {
                        if (progressPercent) progressPercent.textContent = '0%';
                        if (progressFill) progressFill.style.width = '0%';
                        if (totalItems) totalItems.textContent = '0';
                        if (completedItems) completedItems.textContent = '0';
                        if (avgScore) avgScore.textContent = '--';
                        return;
                    }
                    
                    const stats = currentExerciseSet.stats || {};
                    const total = stats.total_items || 0;
                    const completed = stats.completed_count || 0;
                    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;
                    
                    if (progressPercent) progressPercent.textContent = `${percent}%`;
                    if (progressFill) progressFill.style.width = `${percent}%`;
                    if (totalItems) totalItems.textContent = total;
                    if (completedItems) completedItems.textContent = completed;
                    if (avgScore) avgScore.textContent = stats.average_score ? stats.average_score.toFixed(1) : '--';
                }
                
                // æ¨¡å¼åˆ‡æ¢
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        modeBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        currentPracticeMode = btn.dataset.mode;
                        resetExerciseArea();
                    });
                });
                
                // æ–‡æœ¬å¯¼å…¥åŠŸèƒ½ä¿®å¤
                if (importTextBtn) {
                    console.log('ğŸ”— ç»‘å®šæ–‡æœ¬å¯¼å…¥æŒ‰é’®äº‹ä»¶');
                    importTextBtn.addEventListener('click', async () => {
                        console.log('ğŸ”„ æ–‡æœ¬å¯¼å…¥æŒ‰é’®è¢«ç‚¹å‡»');
                        
                        const content = importTextArea ? importTextArea.value.trim() : '';
                        const name = exerciseNameInput ? exerciseNameInput.value.trim() : '';
                        
                        console.log('ğŸ“‹ å¯¼å…¥å†…å®¹:', { content: content.substring(0, 100) + '...', name });
                        
                        if (!content) {
                            alert('è¯·è¾“å…¥ç»ƒä¹ å†…å®¹');
                            console.warn('âš ï¸ ç»ƒä¹ å†…å®¹ä¸ºç©º');
                            return;
                        }
                        
                        const finalName = name || `æ–‡æœ¬ç»ƒä¹ _${new Date().toLocaleDateString()}`;
                        console.log(`ğŸ·ï¸ æœ€ç»ˆç»ƒä¹ é›†åç§°: ${finalName}`);
                        
                        try {
                            importTextBtn.textContent = 'å¯¼å…¥ä¸­...';
                            importTextBtn.disabled = true;
                            console.log('ğŸš€ å¼€å§‹å‘æœåŠ¡å™¨å‘é€å¯¼å…¥è¯·æ±‚...');
                            
                            const response = await axios.post('/api/import-exercise', { 
                                content, 
                                name: finalName 
                            });
                            
                            console.log('ğŸ“¦ æœåŠ¡å™¨å“åº”:', response.data);
                            
                            if (response.data.success) {
                                alert(response.data.message);
                                console.log('âœ… å¯¼å…¥æˆåŠŸï¼Œåˆ·æ–°ç»ƒä¹ é›†åˆ—è¡¨...');
                                
                                // æ¸…ç©ºè¾“å…¥
                                if (importTextArea) importTextArea.value = '';
                                if (exerciseNameInput) exerciseNameInput.value = '';
                                
                                // åˆ‡æ¢åˆ°ç»ƒä¹ æ¨¡å¼
                                const practiceBtn = document.querySelector('[data-mode="practice"]');
                                if (practiceBtn) {
                                    practiceBtn.click();
                                    console.log('ğŸ”„ å·²åˆ‡æ¢åˆ°ç»ƒä¹ æ¨¡å¼');
                                    
                                    // ç­‰å¾…æ¨¡å¼åˆ‡æ¢å®ŒæˆååŠ è½½ç»ƒä¹ é›†
                                    setTimeout(async () => {
                                        await loadPracticeExercises();
                                        
                                        // è‡ªåŠ¨é€‰ä¸­æ–°åˆ›å»ºçš„ç»ƒä¹ é›†
                                        const practiceSelect = document.getElementById('practice-exercise-select');
                                        if (practiceSelect && response.data.exercise_id) {
                                            practiceSelect.value = response.data.exercise_id;
                                            await updateProgressForSelectedExercise();
                                            console.log(`ğŸ¯ è‡ªåŠ¨é€‰ä¸­æ–°åˆ›å»ºçš„ç»ƒä¹ é›†: ${response.data.exercise_id}`);
                                        }
                                    }, 500);
                                }
                                
                                console.log('ğŸ§¹ å·²æ¸…ç©ºè¾“å…¥æ¡†');
                                
                            } else {
                                throw new Error(response.data.error || 'å¯¼å…¥å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('âŒ å¯¼å…¥å¤±è´¥:', error);
                            const errorMsg = error.response?.data?.error || error.message || 'å¯¼å…¥ç»ƒä¹ å¤±è´¥ï¼Œè¯·é‡è¯•';
                            alert(errorMsg);
                        } finally {
                            importTextBtn.textContent = 'å¯¼å…¥æ–‡æœ¬åˆ›å»ºç»ƒä¹ é›†';
                            importTextBtn.disabled = false;
                            console.log('ğŸ”„ æŒ‰é’®çŠ¶æ€æ¢å¤');
                        }
                    });
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°æ–‡æœ¬å¯¼å…¥æŒ‰é’® (importTextBtn)');
                }
                
                // å¼€å§‹ç»ƒä¹ åŠŸèƒ½ä¿®å¤
                if (startPracticeBtn) {
                    console.log('ğŸ”— ç»‘å®šå¼€å§‹ç»ƒä¹ æŒ‰é’®äº‹ä»¶');
                    startPracticeBtn.addEventListener('click', async () => {
                        console.log('ğŸ¯ å¼€å§‹ç»ƒä¹ æŒ‰é’®è¢«ç‚¹å‡»');
                        
                        if (!currentExerciseSet) {
                            alert('è¯·å…ˆé€‰æ‹©æˆ–åˆ›å»ºç»ƒä¹ é›†');
                            console.warn('âš ï¸ æœªé€‰æ‹©ç»ƒä¹ é›†');
                            return;
                        }
                        
                        console.log(`ğŸ“š å½“å‰ç»ƒä¹ é›†: ${currentExerciseSet.name} (ID: ${currentExerciseSet.id})`);
                        
                        try {
                            startPracticeBtn.textContent = 'åŠ è½½ä¸­...';
                            startPracticeBtn.disabled = true;
                            console.log('ğŸš€ å¼€å§‹åŠ è½½ç»ƒä¹ é¡¹ç›®...');
                            
                            const mode = currentPracticeMode === 'speech' ? 'speech' : 'grammar';
                            const difficulty = difficultySelect ? difficultySelect.value : '';
                            
                            console.log(`ğŸ² ç»ƒä¹ å‚æ•°: æ¨¡å¼=${mode}, éš¾åº¦=${difficulty || 'å…¨éƒ¨'}`);
                            
                            const requestData = {
                                exercise_id: currentExerciseSet.id,
                                mode,
                                difficulty
                            };
                            
                            console.log('ğŸ“¤ å‘é€è¯·æ±‚åˆ° /api/custom-exercise:', requestData);
                            
                            const response = await axios.post('/api/custom-exercise', requestData);
                            console.log('ğŸ“¦ æœåŠ¡å™¨å“åº”:', response.data);
                            
                            if (response.data.error) {
                                throw new Error(response.data.error);
                            }
                            
                            currentExerciseItem = response.data;
                            exerciseStartTime = Date.now();
                            
                            console.log('âœ… è·å–ç»ƒä¹ é¡¹ç›®æˆåŠŸï¼Œå¼€å§‹æ˜¾ç¤º...');
                            displayExerciseItem();
                            
                            // æ›´æ–°ç•Œé¢çŠ¶æ€
                            startPracticeBtn.style.display = 'none';
                            if (submitAnswerBtn) {
                                submitAnswerBtn.style.display = 'flex';
                                console.log('ğŸ“ æ˜¾ç¤ºæäº¤ç­”æ¡ˆæŒ‰é’®');
                            }
                            if (nextExerciseBtn) nextExerciseBtn.style.display = 'none';
                            if (resultArea) resultArea.style.display = 'none';
                            
                        } catch (error) {
                            console.error('âŒ åŠ è½½ç»ƒä¹ å¤±è´¥:', error);
                            const errorMsg = error.response?.data?.error || error.message || 'åŠ è½½ç»ƒä¹ å¤±è´¥ï¼Œè¯·é‡è¯•';
                            alert(errorMsg);
                        } finally {
                            startPracticeBtn.textContent = 'å¼€å§‹ç»ƒä¹ ';
                            startPracticeBtn.disabled = false;
                            console.log('ğŸ”„ æŒ‰é’®çŠ¶æ€æ¢å¤');
                        }
                    });
                } else {
                    console.warn('âš ï¸ æœªæ‰¾åˆ°å¼€å§‹ç»ƒä¹ æŒ‰é’® (startPracticeBtn)');
                }
                
                // æ˜¾ç¤ºç»ƒä¹ é¢˜ç›®
                function displayExerciseItem() {
                    if (!currentExerciseItem || !exerciseContent) return;
                    
                    if (resultArea) {
                        resultArea.style.display = 'none';
                        resultArea.innerHTML = '';
                    }
                    customAudioBlob = null;
                    
                    const diffText = currentExerciseItem.difficulty ? `<div style="margin-top: 12px; font-size: 0.85rem; color: #868E96;">éš¾åº¦: <span style="color: #3A86FF; font-weight: 600;">${getDifficultyText(currentExerciseItem.difficulty)}</span></div>` : '';
                    
                    if (currentExerciseItem.reference_text) {
                        exerciseContent.innerHTML = `
                            <div style="text-align: left;">
                                <div style="font-size: 0.9rem; color: #868E96; margin-bottom: 8px;">è¯·æœ—è¯»ä»¥ä¸‹å†…å®¹ï¼š</div>
                                <div style="font-size: 1.3rem; font-weight: 500; color: #212529; line-height: 1.6;">${currentExerciseItem.reference_text}</div>
                                ${diffText}
                            </div>
                        `;
                        if (voiceInputArea) voiceInputArea.style.display = 'block';
                        if (textInputArea) textInputArea.style.display = 'none';
                        if (recordStatus) recordStatus.textContent = 'æœªå½•éŸ³';
                        if (recordProgress) recordProgress.style.width = '0%';
                    } else if (currentExerciseItem.chinese_sentence) {
                        exerciseContent.innerHTML = `
                            <div style="text-align: left;">
                                <div style="font-size: 0.9rem; color: #868E96; margin-bottom: 8px;">è¯·å°†ä»¥ä¸‹ä¸­æ–‡ç¿»è¯‘ä¸ºè‹±æ–‡ï¼š</div>
                                <div style="font-size: 1.3rem; font-weight: 500; color: #212529; line-height: 1.6;">${currentExerciseItem.chinese_sentence}</div>
                                ${diffText}
                            </div>
                        `;
                        if (voiceInputArea) voiceInputArea.style.display = 'none';
                        if (textInputArea) textInputArea.style.display = 'block';
                        if (answerTextarea) answerTextarea.value = '';
                    }
                }
                
                function getDifficultyText(difficulty) {
                    const map = { easy: 'ç®€å•', medium: 'ä¸­ç­‰', hard: 'å›°éš¾' };
                    return map[difficulty] || difficulty;
                }
                
                // å½•éŸ³åŠŸèƒ½
                if (recordCustomBtn) {
                    recordCustomBtn.addEventListener('click', async () => {
                        const isRecording = recordCustomBtn.classList.contains('recording');
                        
                        if (!isRecording) {
                            try {
                                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                customChunks = [];
                                customMediaRecorder = new MediaRecorder(stream);
                                
                                customMediaRecorder.ondataavailable = (e) => {
                                    if (e.data.size > 0) customChunks.push(e.data);
                                };
                                
                                customMediaRecorder.onstop = () => {
                                    customAudioBlob = new Blob(customChunks, { type: 'audio/webm' });
                                    stream.getTracks().forEach(t => t.stop());
                                    if (recordStatus) recordStatus.textContent = 'å½•éŸ³å®Œæˆ';
                                    if (recordProgress) {
                                        recordProgress.style.width = '100%';
                                        recordProgress.style.background = '#52B788';
                                    }
                                };
                                
                                customMediaRecorder.start();
                                recordCustomBtn.classList.add('recording');
                                if (recordStatus) recordStatus.textContent = 'å½•éŸ³ä¸­...';
                                if (recordProgress) {
                                    recordProgress.style.width = '50%';
                                    recordProgress.style.background = '#E63946';
                                }
                                
                            } catch (error) {
                                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                            }
                        } else {
                            if (customMediaRecorder && customMediaRecorder.state !== 'inactive') {
                                customMediaRecorder.stop();
                                recordCustomBtn.classList.remove('recording');
                            }
                        }
                    });
                }
                
                // æäº¤ç­”æ¡ˆ
                if (submitAnswerBtn) {
                    submitAnswerBtn.addEventListener('click', async () => {
                        if (!currentExerciseItem) return;
                        
                        try {
                            submitAnswerBtn.textContent = 'è¯„åˆ†ä¸­...';
                            submitAnswerBtn.disabled = true;
                            
                            let score = 0;
                            let feedback = '';
                            
                            if (currentExerciseItem.reference_text) {
                                if (!customAudioBlob) {
                                    alert('è¯·å…ˆå½•éŸ³');
                                    return;
                                }
                                
                                const formData = new FormData();
                                formData.append('reference_text', currentExerciseItem.reference_text);
                                formData.append('audio_file', customAudioBlob, 'custom_recording.webm');
                                
                                const response = await axios.post('/api/score-pronunciation-simple', formData);
                                score = parseFloat(response.data.score);
                                feedback = `æ‚¨çš„å‘éŸ³å¾—åˆ†ï¼š<span style="font-size: 2rem; font-weight: 800; color: #3A86FF;">${score}</span>åˆ†`;
                                
                            } else if (currentExerciseItem.chinese_sentence) {
                                const userAnswer = answerTextarea ? answerTextarea.value.trim() : '';
                                if (!userAnswer) {
                                    alert('è¯·è¾“å…¥æ‚¨çš„ç¿»è¯‘');
                                    return;
                                }
                                
                                const response = await axios.post('/api/check-grammar-text', { text: userAnswer });
                                
                                if (response.data.success) {
                                    score = 100;
                                    feedback = '<div style="color: #52B788; font-size: 1.2rem;">âœ… è¯­æ³•æ­£ç¡®ï¼</div>';
                                } else {
                                    score = Math.max(0, 100 - response.data.error_count * 10);
                                    feedback = `<div style="color: #E63946; font-size: 1.1rem;">âŒ æ£€æµ‹åˆ° ${response.data.error_count} å¤„è¯­æ³•é—®é¢˜</div>`;
                                    response.data.errors.forEach((err, idx) => {
                                        feedback += `<div style="margin-top: 8px; padding: 8px; background: #FFF5F5; border-radius: 4px; font-size: 0.9rem;">
                                            <strong>ã€é”™è¯¯ ${idx + 1}ã€‘</strong> ${err.message}
                                        </div>`;
                                    });
                                    
                                    if (currentExerciseItem.reference_english) {
                                        feedback += `<div style="margin-top: 12px; padding: 12px; background: #E9F1FF; border-radius: 4px;">
                                            <div style="font-size: 0.9rem; color: #868E96; margin-bottom: 4px;">å‚è€ƒç­”æ¡ˆï¼š</div>
                                            <div style="font-size: 1rem; color: #212529;">${currentExerciseItem.reference_english}</div>
                                        </div>`;
                                    }
                                }
                            }
                            
                            if (resultArea) {
                                resultArea.innerHTML = `<div style="text-align: center;">${feedback}</div>`;
                                resultArea.style.display = 'block';
                            }
                            
                            // è®°å½•ç»“æœ
                            if (currentExerciseItem.item_id) {
                                const timeSpent = (Date.now() - exerciseStartTime) / 1000;
                                await axios.post('/api/exercise-results', {
                                    exercise_id: currentExerciseSet.id,
                                    item_id: currentExerciseItem.item_id,
                                    score,
                                    time_spent: timeSpent
                                });
                                await onExerciseSetChange();
                            }
                            
                            submitAnswerBtn.style.display = 'none';
                            if (nextExerciseBtn) {
                                // éšè—ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œç­‰å¾…ç”¨æˆ·æŸ¥çœ‹ç»“æœ
                                nextExerciseBtn.style.display = 'none';
                                
                                // åœ¨ç»“æœåŒºåŸŸæ·»åŠ æŸ¥çœ‹æ—¶é—´æç¤º
                                if (resultArea) {
                                    const originalContent = resultArea.innerHTML;
                                    resultArea.innerHTML = originalContent + `
                                        <div id="mainResultTimer" style="margin-top: 16px; padding: 12px; background: #E9F1FF; border-radius: 6px; text-align: center;">
                                            <div style="color: #3A86FF; font-weight: 600; margin-bottom: 8px;">ğŸ•°ï¸ è¯·ä»”ç»†æŸ¥çœ‹ç»ƒä¹ ç»“æœ</div>
                                            <div style="color: #495057; font-size: 0.9rem;">â€œä¸‹ä¸€é¢˜â€æŒ‰é’®å°†åœ¨ <span id="mainCountdown" style="font-weight: 600; color: #E63946;">8</span> ç§’åæ˜¾ç¤º</div>
                                            <div style="margin-top: 8px;">
                                                <button onclick="showMainNextButtonEarly()" style="background: #52B788; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem;">
                                                    ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                                </button>
                                                <button onclick="extendMainViewTime()" style="background: #FFD166; color: #212529; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 8px;">
                                                    ç»§ç»­æŸ¥çœ‹ (+5ç§’)
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }
                                
                                // å¯åŠ¨ä¸»ç»ƒä¹ åŒºåŸŸçš„å€’è®¡æ—¶
                                startMainResultCountdown(nextExerciseBtn);
                            }
                            
                        } catch (error) {
                            alert(error.response?.data?.error || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                        } finally {
                            submitAnswerBtn.textContent = 'æäº¤ç­”æ¡ˆ';
                            submitAnswerBtn.disabled = false;
                        }
                    });
                }
                
                // ä¸‹ä¸€é¢˜
                if (nextExerciseBtn) {
                    nextExerciseBtn.addEventListener('click', () => {
                        if (startPracticeBtn) startPracticeBtn.click();
                    });
                }
                
                // é‡ç½®ç»ƒä¹ åŒºåŸŸ
                function resetExerciseArea() {
                    if (exerciseContent) {
                        exerciseContent.innerHTML = `
                            <div style="text-align: center; color: #868E96;">
                                <iconify-icon icon="mdi:book-open-variant" width="64" height="64" style="color: #DEE2E6; margin-bottom: 16px;"></iconify-icon>
                                <p>è¯·å…ˆå¯¼å…¥ç»ƒä¹ å†…å®¹æˆ–é€‰æ‹©ç»ƒä¹ é›†</p>
                            </div>
                        `;
                    }
                    if (voiceInputArea) voiceInputArea.style.display = 'none';
                    if (textInputArea) textInputArea.style.display = 'none';
                    if (resultArea) resultArea.style.display = 'none';
                    if (startPracticeBtn) startPracticeBtn.style.display = 'flex';
                    if (submitAnswerBtn) submitAnswerBtn.style.display = 'none';
                    if (nextExerciseBtn) nextExerciseBtn.style.display = 'none';
                    currentExerciseItem = null;
                }
                
                // ä¿®å¤ç»“æŸï¼Œæ·»åŠ è°ƒè¯•åŠŸèƒ½
                window.debugCustomExercise = function() {
                    console.log('ğŸ” è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å—è°ƒè¯•ä¿¡æ¯:');
                    console.log('  å½“å‰ç»ƒä¹ é›†:', currentExerciseSet);
                    console.log('  å½“å‰ç»ƒä¹ é¡¹ç›®:', currentExerciseItem);
                    console.log('  å½“å‰æ¨¡å¼:', currentPracticeMode);
                    console.log('  DOMå…ƒç´ æ£€æŸ¥:', {
                        exerciseSetSelect: !!exerciseSetSelect,
                        importTextBtn: !!importTextBtn,
                        startPracticeBtn: !!startPracticeBtn,
                        exerciseContent: !!exerciseContent,
                        voiceInputArea: !!voiceInputArea,
                        textInputArea: !!textInputArea
                    });
                    
                    // è¯•ç€é‡æ–°åŠ è½½ç»ƒä¹ é›†
                    console.log('ğŸ”„ å°è¯•é‡æ–°åŠ è½½ç»ƒä¹ é›†...');
                    loadExerciseSets().then(() => {
                        console.log('âœ… é‡æ–°åŠ è½½å®Œæˆ');
                    }).catch(err => {
                        console.error('âŒ é‡æ–°åŠ è½½å¤±è´¥:', err);
                    });
                };
                
                // æä¾›å¿«æ·æµ‹è¯•æ–¹æ³•
                window.testCustomExerciseImport = function() {
                    const testContent = `Hello world
This is a test sentence
ä½ å¥½|ä¸–ç•Œ
Hello|World`;
                    
                    if (importTextArea) {
                        importTextArea.value = testContent;
                        console.log('âœ… å·²å¡«å…¥æµ‹è¯•å†…å®¹');
                    }
                    
                    if (exerciseNameInput) {
                        exerciseNameInput.value = 'æµ‹è¯•ç»ƒä¹ é›†_' + new Date().getTime();
                        console.log('âœ… å·²å¡«å…¥æµ‹è¯•åç§°');
                    }
                    
                    console.log('ğŸ“ ç°åœ¨å¯ä»¥ç‚¹å‡»"å¯¼å…¥æ–‡æœ¬åˆ›å»ºç»ƒä¹ é›†"æŒ‰é’®è¿›è¡Œæµ‹è¯•');
                };
                
                console.log('âœ… è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                console.log('ğŸ  è°ƒè¯•æç¤º: åœ¨æ§åˆ¶å°è¾“å…¥ debugCustomExercise() æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯');
                console.log('ğŸ  æµ‹è¯•æç¤º: åœ¨æ§åˆ¶å°è¾“å…¥ testCustomExerciseImport() è‡ªåŠ¨å¡«å…¥æµ‹è¯•æ•°æ®');
            })();

            // è‡ªå®šä¹‰ç»ƒä¹ æ¨¡å—å¢å¼ºåŠŸèƒ½
            const customModule = document.getElementById('custom');
            if (customModule) {
                let currentExerciseId = null;
                let currentItemId = null;
                let customRecording = { mediaRecorder: null, chunks: [], audioBlob: null, isRecording: false };
                let exerciseStartTime = null;
                
                // æ¨¡å¼åˆ‡æ¢
                const modeBtns = customModule.querySelectorAll('[data-mode]');
                const textImportArea = document.getElementById('text-import-area');
                const practiceModeArea = document.getElementById('practice-mode-area');
                
                modeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        modeBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        const mode = btn.dataset.mode;
                        
                        if (mode === 'text') {
                            textImportArea.style.display = 'block';
                            practiceModeArea.style.display = 'none';
                        } else if (mode === 'practice') {
                            textImportArea.style.display = 'none';
                            practiceModeArea.style.display = 'block';
                            loadPracticeExercises(); // åŠ è½½ç»ƒä¹ é›†åˆ—è¡¨
                        }
                    });
                });
                
                // æ–‡æœ¬å¯¼å…¥åŠŸèƒ½ï¼ˆå·²åœ¨ä¸Šé¢å®ç°ï¼Œæ­¤å¤„ç§»é™¤é‡å¤ä»£ç ï¼‰

                
                // ç»ƒä¹ åŠŸèƒ½
                async function loadPracticeExercises() {
                    try {
                        const response = await axios.get('/api/exercise-sets');
                        const exerciseSets = response.data.exercise_sets || [];
                        const practiceSelect = document.getElementById('practice-exercise-select');
                        
                        if (practiceSelect) {
                            practiceSelect.innerHTML = '<option value="">é€‰æ‹©ç»ƒä¹ é›†...</option>';
                            exerciseSets.forEach(set => {
                                const option = document.createElement('option');
                                option.value = set.id;
                                option.textContent = `${set.name} (${set.stats?.total_items || 0}é¢˜)`;
                                practiceSelect.appendChild(option);
                                console.log(`æ·»åŠ ç»ƒä¹ é›†é€‰é¡¹: ${set.name} (ID: ${set.id})`);
                            });
                            
                            // ç›‘å¬ç»ƒä¹ é›†é€‰æ‹©å˜åŒ–
                            practiceSelect.removeEventListener('change', updateProgressForSelectedExercise); // é¿å…é‡å¤ç»‘å®š
                            practiceSelect.addEventListener('change', updateProgressForSelectedExercise);
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç»ƒä¹ é€‰é¡¹å¤±è´¥:', error);
                    }
                }
                
                // æ›´æ–°é€‰ä¸­ç»ƒä¹ é›†çš„è¿›åº¦æ˜¾ç¤º
                async function updateProgressForSelectedExercise() {
                    const practiceSelect = document.getElementById('practice-exercise-select');
                    const exerciseId = practiceSelect?.value;
                    
                    if (!exerciseId) {
                        // æ¸…ç©ºè¿›åº¦æ˜¾ç¤º
                        document.getElementById('totalItems').textContent = '0';
                        document.getElementById('completedItems').textContent = '0';
                        document.getElementById('progressPercent').textContent = '0%';
                        document.getElementById('progressFill').style.width = '0%';
                        document.getElementById('avgScore').textContent = '--';
                        return;
                    }
                    
                    try {
                        // è·å–ç»ƒä¹ é›†è¯¦ç»†ä¿¡æ¯
                        const response = await axios.get(`/api/exercise-sets/${exerciseId}`);
                        const exerciseSet = response.data;
                        
                        if (exerciseSet && exerciseSet.stats) {
                            const stats = exerciseSet.stats;
                            const totalItems = stats.total_items || 0;
                            const completedItems = stats.completed_count || 0;
                            const progressPercent = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
                            const avgScore = stats.average_score || 0;
                            
                            // æ›´æ–°æ˜¾ç¤º
                            document.getElementById('totalItems').textContent = totalItems;
                            document.getElementById('completedItems').textContent = completedItems;
                            document.getElementById('progressPercent').textContent = `${progressPercent}%`;
                            document.getElementById('progressFill').style.width = `${progressPercent}%`;
                            document.getElementById('avgScore').textContent = avgScore > 0 ? avgScore.toFixed(1) : '--';
                        }
                    } catch (error) {
                        console.error('è·å–ç»ƒä¹ é›†ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                    }
                }
                
                const startCustomPracticeBtn = document.getElementById('start-custom-practice-btn');
                if (startCustomPracticeBtn) {
                    startCustomPracticeBtn.addEventListener('click', async () => {
                        const exerciseId = document.getElementById('practice-exercise-select')?.value;
                        const practiceType = document.getElementById('practice-type-select')?.value || 'speech';
                        const difficulty = document.getElementById('difficulty-select')?.value || '';
                        
                        if (!exerciseId) { alert('è¯·é€‰æ‹©ç»ƒä¹ é›†'); return; }
                        
                        try {
                            exerciseStartTime = Date.now();
                            
                            console.log('ğŸš€ å‘é€è¯·æ±‚åˆ° /api/custom-exercise');
                            console.log('ğŸ“ è¯·æ±‚å‚æ•°:', {
                                exercise_id: exerciseId,
                                mode: practiceType === 'phoneme' ? 'speech' : practiceType,
                                difficulty: difficulty
                            });
                            
                            const response = await axios.post('/api/custom-exercise', {
                                exercise_id: exerciseId,
                                mode: practiceType === 'phoneme' ? 'speech' : practiceType,
                                difficulty: difficulty
                            });
                            
                            console.log('ğŸ“¦ æœåŠ¡å™¨å“åº”:', response.data);
                            
                            if (response.data.error) {
                                console.error('âŒ æœåŠ¡å™¨è¿”å›é”™è¯¯:', response.data.error);
                                alert(`ç»ƒä¹ è·å–å¤±è´¥: ${response.data.error}`);
                                return;
                            }
                            
                            // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ç»ƒä¹ å†…å®¹
                            const hasValidContent = (response.data.reference_text && response.data.reference_text.trim()) || 
                                                   (response.data.chinese_sentence && response.data.chinese_sentence.trim());
                            
                            if (!hasValidContent) {
                                console.error('âŒ æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ç»ƒä¹ å†…å®¹');
                                alert('æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç»ƒä¹ é¡¹ç›®ï¼Œè¯·æ£€æŸ¥ç»ƒä¹ é›†å†…å®¹æˆ–å°è¯•å…¶ä»–éš¾åº¦');
                                return;
                            }
                            
                            currentExerciseId = response.data.exercise_id || exerciseId;
                            currentItemId = response.data.item_id;
                            
                            console.log('âœ… è·å–ç»ƒä¹ é¡¹ç›®æˆåŠŸï¼Œå¼€å§‹æ˜¾ç¤º...');
                            displayCustomExercise(response.data, practiceType);
                            
                        } catch (error) {
                            console.error('âŒ å¼€å§‹ç»ƒä¹ å¤±è´¥:', error);
                            if (error.response) {
                                console.error('é”™è¯¯å“åº”:', error.response.data);
                                alert(`å¼€å§‹ç»ƒä¹ å¤±è´¥: ${error.response.data.error || error.response.data.message || 'æœåŠ¡å™¨é”™è¯¯'}`);
                            } else if (error.request) {
                                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                            } else {
                                alert(`å¼€å§‹ç»ƒä¹ å¤±è´¥: ${error.message}`);
                            }
                        }
                    });
                }
                
                function displayCustomExercise(exerciseData, type) {
                    const contentArea = document.getElementById('custom-exercise-content');
                    const controlsArea = document.getElementById('custom-exercise-controls');
                    const inputArea = document.getElementById('custom-input-area');
                    
                    console.log('ğŸ“º æ˜¾ç¤ºç»ƒä¹ å†…å®¹:', { type, exerciseData });
                    
                    if (!contentArea) {
                        console.error('âŒ æ‰¾ä¸åˆ°å†…å®¹æ˜¾ç¤ºåŒºåŸŸ');
                        return;
                    }
                    
                    if ((type === 'speech' || type === 'phoneme') && exerciseData.reference_text) {
                        const exerciseTitle = type === 'phoneme' ? 'ğŸ”Š è¯·æœ—è¯»ä»¥ä¸‹å†…å®¹ï¼ˆéŸ³ç´ çº§è¯„åˆ†ï¼‰ï¼š' : 'ğŸ¤ è¯·æœ—è¯»ä»¥ä¸‹å†…å®¹ï¼š';
                        
                        if (contentArea) {
                            contentArea.innerHTML = `
                                <div style="text-align: center;">
                                    <p style="font-size: 1.2rem; margin-bottom: 16px; color: #495057;">${exerciseTitle}</p>
                                    <p style="font-size: 1.5rem; font-weight: 500; color: #212529; line-height: 1.6; background: #F8F9FA; padding: 16px; border-radius: 8px; border-left: 4px solid #3A86FF;">${exerciseData.reference_text}</p>
                                    ${type === 'phoneme' ? '<p style="font-size: 0.9rem; color: #868E96; margin-top: 8px;">éŸ³ç´ çº§è¯„åˆ†å°†æä¾›è¯¦ç»†çš„å‘éŸ³åˆ†æå’Œæ”¹è¿›å»ºè®®</p>' : ''}
                                    ${exerciseData.difficulty ? `<p style="font-size: 0.9rem; color: #868E96; margin-top: 8px;">éš¾åº¦: ${getDifficultyText(exerciseData.difficulty)}</p>` : ''}
                                </div>
                            `;
                        }
                        if (inputArea) inputArea.style.display = 'none';
                        if (controlsArea) {
                            controlsArea.innerHTML = `
                                <button id="record-custom-btn" style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin: 5px;">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                                <button id="submit-custom-answer-btn" style="display: none; background: #52B788; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin: 5px;">ğŸ“¤ æäº¤è¯„åˆ†</button>
                                <button id="next-exercise-btn" onclick="document.getElementById('start-custom-practice-btn').click()" style="display: none; background: #FFD166; color: #212529; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin: 5px;">â¡ï¸ ä¸‹ä¸€é¢˜</button>
                            `;
                        }
                        setupSpeechRecording(type);
                        
                    } else if (type === 'grammar' && exerciseData.chinese_sentence) {
                        if (contentArea) {
                            contentArea.innerHTML = `
                                <div style="text-align: center;">
                                    <p style="font-size: 1.2rem; margin-bottom: 16px; color: #495057;">âœï¸ è¯·ç¿»è¯‘ä»¥ä¸‹ä¸­æ–‡ï¼š</p>
                                    <p style="font-size: 1.5rem; font-weight: 500; color: #212529; line-height: 1.6; background: #F8F9FA; padding: 16px; border-radius: 8px; border-left: 4px solid #52B788;">${exerciseData.chinese_sentence}</p>
                                    ${exerciseData.difficulty ? `<p style="font-size: 0.9rem; color: #868E96; margin-top: 8px;">éš¾åº¦: ${getDifficultyText(exerciseData.difficulty)}</p>` : ''}
                                </div>
                            `;
                        }
                        if (inputArea) {
                            inputArea.style.display = 'block';
                            const answerInput = document.getElementById('custom-answer-input');
                            if (answerInput) {
                                answerInput.value = '';
                                answerInput.placeholder = 'è¯·åœ¨æ­¤è¾“å…¥æ‚¨çš„è‹±æ–‡ç¿»è¯‘...';
                            }
                        }
                        if (controlsArea) {
                            controlsArea.innerHTML = `
                                <button id="submit-custom-answer-btn" style="background: #3A86FF; color: white; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin: 5px;">ğŸ“¤ æäº¤æ£€æµ‹</button>
                                <button id="next-exercise-btn" onclick="document.getElementById('start-custom-practice-btn').click()" style="display: none; background: #FFD166; color: #212529; padding: 12px 24px; border-radius: 6px; border: none; cursor: pointer; margin: 5px;">â¡ï¸ ä¸‹ä¸€é¢˜</button>
                            `;
                        }
                        setupGrammarSubmission();
                    } else {
                        console.error('âŒ æ— æ•ˆçš„ç»ƒä¹ æ•°æ®:', { type, reference_text: exerciseData.reference_text, chinese_sentence: exerciseData.chinese_sentence });
                        if (contentArea) {
                            contentArea.innerHTML = `
                                <div style="text-align: center; color: #E63946; padding: 20px;">
                                    <iconify-icon icon="mdi:alert-circle" width="48" height="48" style="margin-bottom: 16px;"></iconify-icon>
                                    <p>ç»ƒä¹ å†…å®¹åŠ è½½å¤±è´¥</p>
                                    <p style="font-size: 0.9rem; color: #868E96; margin-top: 8px;">è¯·æ£€æŸ¥ç»ƒä¹ é›†å†…å®¹æˆ–å°è¯•å…¶ä»–ç»ƒä¹ ç±»å‹</p>
                                </div>
                            `;
                        }
                    }
                    
                    // æ·»åŠ éš¾åº¦è¯´æ˜å‡½æ•°
                    function getDifficultyText(difficulty) {
                        const difficultyMap = {
                            'easy': 'ç®€å• - çŸ­å¥å­ï¼Œå¸¸ç”¨è¯æ±‡',
                            'medium': 'ä¸­ç­‰ - ä¸­ç­‰é•¿åº¦ï¼Œæ­£å¸¸éš¾åº¦',
                            'hard': 'å›°éš¾ - é•¿å¥å­ï¼Œå¤æ‚è¯­æ³•'
                        };
                        return difficultyMap[difficulty] || difficulty || 'æœªçŸ¥';
                    }
                }
                
                function setupSpeechRecording(exerciseType = 'speech') {
                    const recordBtn = document.getElementById('record-custom-btn');
                    const submitBtn = document.getElementById('submit-custom-answer-btn');
                    
                    if (recordBtn) {
                        recordBtn.addEventListener('click', async () => {
                            if (!customRecording.isRecording) {
                                try {
                                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                                    customRecording.chunks = [];
                                    customRecording.mediaRecorder = new MediaRecorder(stream);
                                    
                                    customRecording.mediaRecorder.ondataavailable = (e) => {
                                        if (e.data.size > 0) customRecording.chunks.push(e.data);
                                    };
                                    
                                    customRecording.mediaRecorder.onstop = () => {
                                        customRecording.audioBlob = new Blob(customRecording.chunks, { type: 'audio/webm' });
                                        stream.getTracks().forEach(t => t.stop());
                                        customRecording.isRecording = false;
                                        recordBtn.textContent = 'é‡æ–°å½•éŸ³';
                                        recordBtn.style.background = '#868E96';
                                        if (submitBtn) submitBtn.style.display = 'inline-block';
                                    };
                                    
                                    customRecording.mediaRecorder.start();
                                    customRecording.isRecording = true;
                                    recordBtn.textContent = 'åœæ­¢å½•éŸ³';
                                    recordBtn.style.background = '#E63946';
                                    
                                } catch (error) {
                                    alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                                }
                            } else {
                                if (customRecording.mediaRecorder && customRecording.mediaRecorder.state !== 'inactive') {
                                    customRecording.mediaRecorder.stop();
                                }
                            }
                        });
                    }
                    
                    if (submitBtn) {
                        submitBtn.addEventListener('click', async () => {
                            if (!customRecording.audioBlob) { alert('è¯·å…ˆå½•éŸ³'); return; }
                            
                            const referenceText = document.querySelector('#custom-exercise-content p:nth-child(2)')?.textContent;
                            if (!referenceText) { alert('å‚è€ƒæ–‡æœ¬ç¼ºå¤±'); return; }
                            
                            try {
                                submitBtn.textContent = 'è¯„åˆ†ä¸­...';
                                submitBtn.disabled = true;
                                
                                const formData = new FormData();
                                formData.append('reference_text', referenceText);
                                formData.append('audio_file', customRecording.audioBlob, 'custom_recording.webm');
                                
                                // æ ¹æ®ç»ƒä¹ ç±»å‹é€‰æ‹©ä¸åŒçš„APIç«¯ç‚¹
                                const apiEndpoint = exerciseType === 'phoneme' ? '/api/score-pronunciation-detailed' : '/api/score-pronunciation';
                                console.log(`ä½¿ç”¨APIç«¯ç‚¹: ${apiEndpoint}`);
                                
                                const response = await axios.post(apiEndpoint, formData);
                                let score, detailedResult = null;
                                
                                if (exerciseType === 'phoneme' && response.data.overall_score !== undefined) {
                                    // éŸ³ç´ çº§è¯„åˆ†ç»“æœ
                                    score = parseFloat(response.data.overall_score) || 0;
                                    detailedResult = response.data;
                                } else {
                                    // æ™®é€šè¯„åˆ†ç»“æœ
                                    score = parseFloat(response.data.score) || 0;
                                }
                                
                                // è®°å½•ç»ƒä¹ ç»“æœ
                                if (currentExerciseId && currentItemId) {
                                    const timeSpent = exerciseStartTime ? (Date.now() - exerciseStartTime) / 1000 : 0;
                                    await axios.post('/api/exercise-results', {
                                        exercise_id: currentExerciseId,
                                        item_id: currentItemId,
                                        score: score,
                                        time_spent: timeSpent
                                    });
                                    
                                    // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                                    await updateProgressForSelectedExercise();
                                }
                                
                                showExerciseResult(exerciseType, score, null, detailedResult);
                                
                            } catch (error) {
                                console.error('è¯„åˆ†å¤±è´¥:', error);
                                
                                // æä¾›æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                                let errorMessage = 'è¯„åˆ†å¤±è´¥ï¼Œè¯·é‡è¯•';
                                if (error.response) {
                                    // æœåŠ¡å™¨è¿”å›äº†é”™è¯¯å“åº”
                                    if (error.response.status === 500 && error.response.data && error.response.data.error) {
                                        errorMessage = `è¯„åˆ†é”™è¯¯: ${error.response.data.error}`;
                                    } else {
                                        errorMessage = `æœåŠ¡å™¨é”™è¯¯ (${error.response.status}): ${error.response.statusText}`;
                                    }
                                } else if (error.request) {
                                    // ç½‘ç»œè¿æ¥é—®é¢˜
                                    errorMessage = 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
                                }
                                
                                // å°½ç®¡æœ‰é”™è¯¯ï¼Œä½†å¦‚æœè¿”å›äº†éƒ¨åˆ†æ•°æ®ï¼Œä»ç„¶å°è¯•æ˜¾ç¤ºç»“æœ
                                if (error.response && error.response.data && error.response.data.score) {
                                    const partialScore = parseFloat(error.response.data.score) || 0;
                                    console.log('æ£€æµ‹åˆ°éƒ¨åˆ†è¯„åˆ†æ•°æ®ï¼Œå°†æ˜¾ç¤ºç»“æœ:', partialScore);
                                    showExerciseResult(exerciseType, partialScore, null, null);
                                } else {
                                    alert(errorMessage);
                                }
                            } finally {
                                submitBtn.textContent = 'æäº¤è¯„åˆ†';
                                submitBtn.disabled = false;
                            }
                        });
                    }
                }
                
                function setupGrammarSubmission() {
                    const submitBtn = document.getElementById('submit-custom-answer-btn');
                    if (!submitBtn) return;
                    
                    submitBtn.addEventListener('click', async () => {
                        const answerInput = document.getElementById('custom-answer-input');
                        const answer = answerInput?.value?.trim();
                        
                        if (!answer) { alert('è¯·è¾“å…¥æ‚¨çš„ç¿»è¯‘'); return; }
                        
                        try {
                            submitBtn.textContent = 'æ£€æµ‹ä¸­...';
                            submitBtn.disabled = true;
                            
                            const formData = new FormData();
                            formData.append('translated_text', answer);
                            
                            const response = await axios.post('/api/check-grammar', formData);
                            const result = response.data.result;
                            
                            let score = result.status === 'success' ? 100 : Math.max(0, 100 - (result.error_count * 10));
                            
                            // è®°å½•ç»ƒä¹ ç»“æœ
                            if (currentExerciseId && currentItemId) {
                                const timeSpent = exerciseStartTime ? (Date.now() - exerciseStartTime) / 1000 : 0;
                                await axios.post('/api/exercise-results', {
                                    exercise_id: currentExerciseId,
                                    item_id: currentItemId,
                                    score: score,
                                    time_spent: timeSpent
                                });
                                
                                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                                await updateProgressForSelectedExercise();
                            }
                            
                            showExerciseResult('grammar', score, result);
                            
                        } catch (error) {
                            alert('è¯­æ³•æ£€æµ‹å¤±è´¥ï¼Œè¯·é‡è¯•');
                        } finally {
                            submitBtn.textContent = 'æäº¤æ£€æµ‹';
                            submitBtn.disabled = false;
                        }
                    });
                }
                
                function showExerciseResult(type, score, grammarResult = null, detailedResult = null) {
                    const resultArea = document.getElementById('custom-exercise-result');
                    const nextBtn = document.getElementById('next-exercise-btn');
                    
                    if (resultArea) {
                        let html = `
                            <div style="text-align: center; margin-bottom: 16px;">
                                <h4 style="margin: 0 0 8px 0; color: #212529;">ç»ƒä¹ å®Œæˆï¼</h4>
                                <div style="font-size: 2rem; font-weight: 800; color: ${score >= 80 ? '#52B788' : score >= 60 ? '#3A86FF' : '#E63946'}; margin: 8px 0;">${score.toFixed(1)}</div>
                                <div style="color: #495057;">${score >= 90 ? 'ä¼˜ç§€' : score >= 75 ? 'è‰¯å¥½' : score >= 60 ? 'åŠæ ¼' : 'éœ€è¦æ”¹è¿›'}</div>
                            </div>
                        `;
                        
                        // æ˜¾ç¤ºè¯­æ³•æ£€æµ‹ç»“æœ
                        if (type === 'grammar' && grammarResult && grammarResult.status !== 'success') {
                            html += '<div style="text-align: left; font-size: 0.9rem;">';
                            html += `<p style="color: #E63946; margin-bottom: 8px;">âŒ æ£€æµ‹åˆ° ${grammarResult.error_count} å¤„è¯­æ³•é—®é¢˜ï¼š</p>`;
                            grammarResult.errors.slice(0, 3).forEach((error, i) => {
                                html += `<div style="margin-bottom: 4px; padding: 8px; background: #FFF5F5; border-radius: 4px;"><strong>é”™è¯¯ ${i+1}:</strong> ${error.message}</div>`;
                            });
                            html += '</div>';
                        }
                        
                        // æ˜¾ç¤ºéŸ³ç´ çº§è¯¦ç»†ç»“æœ
                        if (detailedResult && (type === 'phoneme' || type === 'speech')) {
                            // æ£€æŸ¥æ˜¯å¦æœ‰è¯¦ç»†çš„éŸ³ç´ åˆ†ææ•°æ®
                            if (detailedResult.phoneme_scores || detailedResult.word_scores || detailedResult.improvement_suggestions) {
                                html += displayDetailedPronunciationResults(detailedResult);
                            } else {
                                // å¦‚æœæ²¡æœ‰è¯¦ç»†æ•°æ®ï¼Œæ˜¾ç¤ºç®€åŒ–ç‰ˆæœ¬
                                html += `
                                    <div style="margin-top: 16px; padding: 12px; background: #FFF3CD; border-left: 4px solid #FFC107; border-radius: 4px;">
                                        <p style="margin: 0; color: #856404; font-weight: 600;">âš ï¸ ç®€åŒ–è¯„åˆ†æ¨¡å¼</p>
                                        <p style="margin: 4px 0 0 0; color: #856404; font-size: 0.9rem;">å½“å‰ä½¿ç”¨çš„æ˜¯ç®€åŒ–è¯„åˆ†ï¼Œæ— æ³•æä¾›è¯¦ç»†çš„éŸ³ç´ åˆ†æã€‚è¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®æˆ–å°è¯•åœ¨é¦–é¡µä½¿ç”¨è¯¦ç»†è¯„åˆ†æ¨¡å¼ã€‚</p>
                                    </div>
                                `;
                            }
                        }
                        
                        // æ·»åŠ æŸ¥çœ‹æ—¶é—´æç¤ºå’Œå€’è®¡æ—¶
                        html += `
                            <div id="resultViewTimer" style="margin-top: 20px; padding: 12px; background: #E9F1FF; border-radius: 6px; text-align: center;">
                                <div style="color: #3A86FF; font-weight: 600; margin-bottom: 8px;">ğŸ•°ï¸ è¯·ä»”ç»†æŸ¥çœ‹æ‚¨çš„ç»ƒä¹ ç»“æœ</div>
                                <div style="color: #495057; font-size: 0.9rem;">â€œä¸‹ä¸€é¢˜â€æŒ‰é’®å°†åœ¨ <span id="countdown" style="font-weight: 600; color: #E63946;">10</span> ç§’åæ˜¾ç¤º</div>
                                <div style="margin-top: 8px;">
                                    <button onclick="showNextButtonEarly()" style="background: #52B788; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem;">
                                        ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                    </button>
                                    <button onclick="extendViewTime()" style="background: #FFD166; color: #212529; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 8px;">
                                        ç»§ç»­æŸ¥çœ‹ (+10ç§’)
                                    </button>
                                </div>
                            </div>
                        `;
                        
                        resultArea.innerHTML = html;
                        resultArea.style.display = 'block';
                    }
                    
                    // éšè—ä¸‹ä¸€é¢˜æŒ‰é’®ï¼Œå¹¶å¯åŠ¨å€’è®¡æ—¶
                    if (nextBtn) {
                        nextBtn.style.display = 'none';
                        startResultCountdown(nextBtn);
                    }
                }
                
                // å€’è®¡æ—¶åŠŸèƒ½
                let countdownTimer = null;
                let countdownSeconds = 10;
                
                function startResultCountdown(nextBtn) {
                    countdownSeconds = 10;
                    updateCountdownDisplay();
                    
                    countdownTimer = setInterval(() => {
                        countdownSeconds--;
                        updateCountdownDisplay();
                        
                        if (countdownSeconds <= 0) {
                            clearInterval(countdownTimer);
                            showNextButton(nextBtn);
                        }
                    }, 1000);
                }
                
                function updateCountdownDisplay() {
                    const countdownElement = document.getElementById('countdown');
                    if (countdownElement) {
                        countdownElement.textContent = countdownSeconds;
                        // æœ€å3ç§’å˜çº¢è‰²æé†’
                        if (countdownSeconds <= 3) {
                            countdownElement.style.color = '#E63946';
                            countdownElement.style.fontSize = '1.1rem';
                        }
                    }
                }
                
                function showNextButton(nextBtn) {
                    const timerElement = document.getElementById('resultViewTimer');
                    if (timerElement) {
                        timerElement.innerHTML = `
                            <div style="color: #52B788; font-weight: 600;">âœ… ç»“æœæŸ¥çœ‹å®Œæ¯•</div>
                            <div style="color: #495057; font-size: 0.9rem; margin-top: 4px;">ç°åœ¨å¯ä»¥è¿›å…¥ä¸‹ä¸€é¢˜äº†</div>
                        `;
                    }
                    
                    if (nextBtn) {
                        nextBtn.style.display = 'inline-block';
                        // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                        nextBtn.style.animation = 'fadeIn 0.5s ease';
                    }
                }
                
                // æå‰æ˜¾ç¤ºä¸‹ä¸€é¢˜æŒ‰é’®
                window.showNextButtonEarly = function() {
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                        countdownTimer = null;
                    }
                    
                    const nextBtn = document.getElementById('next-exercise-btn');
                    showNextButton(nextBtn);
                };
                
                // å»¶é•¿æŸ¥çœ‹æ—¶é—´
                window.extendViewTime = function() {
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                    }
                    
                    countdownSeconds += 10;
                    const nextBtn = document.getElementById('next-exercise-btn');
                    startResultCountdown(nextBtn);
                    
                    // æ˜¾ç¤ºå»¶é•¿æç¤º
                    const timerElement = document.getElementById('resultViewTimer');
                    if (timerElement) {
                        const existingContent = timerElement.innerHTML;
                        timerElement.innerHTML = `
                            <div style="color: #52B788; font-weight: 600; margin-bottom: 8px;">âœ… å·²å»¶é•¿10ç§’æŸ¥çœ‹æ—¶é—´</div>
                            <div style="color: #495057; font-size: 0.9rem;">â€œä¸‹ä¸€é¢˜â€æŒ‰é’®å°†åœ¨ <span id="countdown" style="font-weight: 600; color: #E63946;">${countdownSeconds}</span> ç§’åæ˜¾ç¤º</div>
                            <div style="margin-top: 8px;">
                                <button onclick="showNextButtonEarly()" style="background: #52B788; color: white; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem;">
                                    ç«‹å³è¿›å…¥ä¸‹ä¸€é¢˜
                                </button>
                                <button onclick="extendViewTime()" style="background: #FFD166; color: #212529; padding: 6px 12px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.85rem; margin-left: 8px;">
                                    å†å»¶é•¿10ç§’
                                </button>
                            </div>
                        `;
                    }
                };
                
                // æ˜¾ç¤ºè¯¦ç»†å‘éŸ³ç»“æœçš„å‡½æ•°
                function displayDetailedPronunciationResults(result) {
                    let detailedHTML = `
                        <div style="margin-top: 20px; padding: 16px; background: #F8F9FA; border-radius: 8px; border: 1px solid #E9ECEF; text-align: left;">
                            <h5 style="margin-bottom: 16px; color: #495057; font-size: 1.1rem;">ğŸ” è¯¦ç»†åˆ†æç»“æœ</h5>
                    `;
                    
                    // æ˜¾ç¤ºéœ€è¦æ”¹è¿›çš„å•è¯
                    if (result.word_scores && result.word_scores.length > 0) {
                        const wordsNeedingImprovement = result.word_scores.filter(ws => ws.needs_improvement);
                        
                        if (wordsNeedingImprovement.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 16px; padding: 12px; background: #FFF5F5; border-left: 4px solid #E63946; border-radius: 4px;">
                                    <h6 style="margin-bottom: 12px; color: #E63946; font-size: 1rem;">ğŸ¯ éœ€è¦é‡ç‚¹æ”¹è¿›çš„å•è¯:</h6>
                            `;
                            
                            wordsNeedingImprovement.forEach(wordInfo => {
                                const qualityColor = {
                                    'excellent': '#52B788',
                                    'good': '#3A86FF', 
                                    'fair': '#FFD166',
                                    'poor': '#E63946',
                                    'unknown': '#868E96'
                                }[wordInfo.quality] || '#868E96';
                                
                                const qualityText = {
                                    'excellent': 'ä¼˜ç§ƒ',
                                    'good': 'è‰¯å¥½', 
                                    'fair': 'ä¸€èˆ¬',
                                    'poor': 'è¾ƒå·®',
                                    'unknown': 'æœªçŸ¥'
                                }[wordInfo.quality] || 'æœªçŸ¥';
                                
                                detailedHTML += `
                                    <div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #E9ECEF;">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                            <strong style="color: #495057; font-size: 1rem;">'${wordInfo.word}'</strong>
                                            <span style="
                                                padding: 3px 8px; 
                                                background: ${qualityColor}; 
                                                color: white; 
                                                border-radius: 12px; 
                                                font-size: 0.8rem;
                                                font-weight: 600;
                                            ">${wordInfo.score.toFixed(1)}åˆ† (${qualityText})</span>
                                        </div>
                                `;
                                
                                // æ˜¾ç¤ºå…·ä½“å»ºè®®
                                if (wordInfo.suggestions && wordInfo.suggestions.length > 0) {
                                    detailedHTML += `
                                        <div style="margin-left: 16px;">
                                            <p style="font-size: 0.9rem; color: #495057; margin-bottom: 4px; font-weight: 600;">ğŸ’¡ æ”¹è¿›å»ºè®®:</p>
                                            <ul style="margin-left: 16px; margin-bottom: 8px;">
                                    `;
                                    wordInfo.suggestions.forEach(suggestion => {
                                        detailedHTML += `<li style="color: #495057; font-size: 0.85rem; margin-bottom: 2px;">${suggestion}</li>`;
                                    });
                                    detailedHTML += `</ul>`;
                                }
                                
                                detailedHTML += `</div>`;
                            });
                            
                            detailedHTML += `</div>`;
                        }
                        
                        // æ˜¾ç¤ºè¡¨ç°è‰¯å¥½çš„å•è¯
                        const goodWords = result.word_scores.filter(ws => !ws.needs_improvement && ws.score > 0);
                        if (goodWords.length > 0) {
                            detailedHTML += `
                                <div style="margin-bottom: 16px; padding: 12px; background: #F0F8F0; border-left: 4px solid #52B788; border-radius: 4px;">
                                    <h6 style="margin-bottom: 8px; color: #52B788; font-size: 0.95rem;">ğŸŒŸ å‘éŸ³è‰¯å¥½çš„å•è¯:</h6>
                                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                            `;
                            goodWords.forEach(wordInfo => {
                                detailedHTML += `
                                    <span style="
                                        padding: 4px 8px;
                                        background: #52B788;
                                        color: white;
                                        border-radius: 12px;
                                        font-size: 0.85rem;
                                        font-weight: 500;
                                    ">'${wordInfo.word}' (${wordInfo.score.toFixed(1)})</span>
                                `;
                            });
                            detailedHTML += `
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    // æ˜¾ç¤ºæ”¹è¿›å»ºè®®
                    if (result.improvement_suggestions && result.improvement_suggestions.length > 0) {
                        detailedHTML += `
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F4FF; border-left: 4px solid #3A86FF; border-radius: 4px;">
                                <h6 style="margin-bottom: 8px; color: #3A86FF; font-weight: 600;">ğŸ’¡ ç»¼åˆæ”¹è¿›å»ºè®®:</h6>
                                <div style="color: #495057; line-height: 1.5;">
                        `;
                        result.improvement_suggestions.forEach(suggestion => {
                            detailedHTML += `<p style="margin: 4px 0; padding-left: 12px;">â€¢ ${suggestion}</p>`;
                        });
                        detailedHTML += `</div></div>`;
                    }
                    
                    // æ˜¾ç¤ºéŸ³ç´ çº§è¯„åˆ†ï¼ˆæŠ˜å æ˜¾ç¤ºï¼‰
                    if (result.phoneme_scores && result.phoneme_scores.length > 0) {
                        detailedHTML += `
                            <details style="margin-bottom: 16px;">
                                <summary style="cursor: pointer; color: #3A86FF; font-weight: 600; margin-bottom: 8px;">ğŸ”Š æŸ¥çœ‹éŸ³ç´ åˆ†æ (${result.phoneme_scores.length}ä¸ªéŸ³ç´ )</summary>
                                <div style="display: flex; flex-wrap: wrap; gap: 4px; padding: 8px; background: white; border-radius: 4px;">
                        `;
                        
                        result.phoneme_scores.forEach(ps => {
                            let bgColor = '#52B788';  // ç»¿è‰²ï¼ˆä¼˜ç§€ï¼‰
                            if (ps.quality === 'good') bgColor = '#3A86FF';      // è“è‰²ï¼ˆè‰¯å¥½ï¼‰
                            else if (ps.quality === 'fair') bgColor = '#FFD166';  // é»„è‰²ï¼ˆä¸€èˆ¬ï¼‰
                            else if (ps.quality === 'poor') bgColor = '#E63946';  // çº¢è‰²ï¼ˆè¾ƒå·®ï¼‰
                            
                            detailedHTML += `
                                <span style="
                                    display: inline-block; 
                                    padding: 4px 8px; 
                                    margin: 2px; 
                                    background: ${bgColor};
                                    color: white; 
                                    border-radius: 4px; 
                                    font-size: 0.9rem;
                                    cursor: pointer;
                                " title="è¯„åˆ†: ${ps.score.toFixed(1)}, æ—¶é—´: ${ps.start_time.toFixed(2)}s-${ps.end_time.toFixed(2)}s">
                                    ${ps.phoneme} (${ps.score.toFixed(0)})
                                </span>
                            `;
                        });
                        
                        detailedHTML += `
                                </div>
                                <p style="font-size: 0.8rem; color: #868E96; margin-top: 8px;">
                                    é¢œè‰²è¯´æ˜: <span style="color: #52B788;">â–ˆ ä¼˜ç§€</span> 
                                    <span style="color: #3A86FF;">â–ˆ è‰¯å¥½</span> 
                                    <span style="color: #FFD166;">â–ˆ ä¸€èˆ¬</span> 
                                    <span style="color: #E63946;">â–ˆ éœ€æ”¹è¿›</span>
                                </p>
                            </details>
                        `;
                    }
                    
                    detailedHTML += `</div>`;
                    return detailedHTML;
                }
            }
            
            // å¯¼å…¥æ–‡æœ¬æŒ‰é’®äº‹ä»¶å·²åœ¨å‰é¢çš„ä»£ç å—ä¸­å¤„ç†ï¼Œé¿å…é‡å¤ç»‘å®š
        });
        
        // ç”¨æˆ·è®¤è¯çŠ¶æ€ç®¡ç†
        function checkAuthStatus() {
            const token = localStorage.getItem('auth_token');
            const userInfo = localStorage.getItem('user_info');
            const userInfoElement = document.getElementById('user-info');
            const guestSection = document.getElementById('guest-info');
            const usernameDisplay = document.getElementById('username-display');
            
            if (token && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                    if (userInfoElement) {
                        userInfoElement.style.display = 'flex';
                        if (usernameDisplay) {
                            usernameDisplay.textContent = user.username || user.full_name || 'ç”¨æˆ·';
                        }
                    }
                    // éšè—ç™»å½•æŒ‰é’®
                    if (guestSection) {
                        guestSection.style.display = 'none';
                    }
                    
                    // è®¾ç½®axiosé»˜è®¤header
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    
                    // ç¡®ä¿cookieä¹Ÿè®¾ç½®äº†tokenï¼ˆä¸ºäº†æœåŠ¡ç«¯éªŒè¯ï¼‰
                    document.cookie = `auth_token=${token}; path=/; max-age=${7*24*60*60}`; // 7å¤©æœ‰æ•ˆæœŸ
                    
                    // éªŒè¯tokenæ˜¯å¦æœ‰æ•ˆ
                    axios.get('/api/user/profile')
                        .catch(error => {
                            // Tokenæ— æ•ˆï¼Œæ¸…é™¤ç™»å½•çŠ¶æ€
                            handleLogout();
                        });
                        
                } catch (error) {
                    console.error('è§£æç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
                    handleLogout();
                }
            } else {
                // æ˜¾ç¤ºç™»å½•æŒ‰é’®
                if (guestSection) {
                    guestSection.style.display = 'block';
                }
                // éšè—ç”¨æˆ·ä¿¡æ¯
                if (userInfoElement) {
                    userInfoElement.style.display = 'none';
                }
                // æ¸…é™¤axios header
                delete axios.defaults.headers.common['Authorization'];
            }
        }
        
        // ç™»å‡ºå¤„ç†
        function handleLogout() {
            // è°ƒç”¨ç™»å‡ºAPI
            const token = localStorage.getItem('auth_token');
            if (token) {
                axios.post('/api/logout', {}, {
                    headers: { 'Authorization': `Bearer ${token}` }
                }).catch(error => {
                    console.log('ç™»å‡ºAPIè°ƒç”¨å¤±è´¥:', error);
                });
            }
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            localStorage.removeItem('auth_token');
            localStorage.removeItem('user_info');
            
            // æ¸…é™¤cookie
            document.cookie = 'auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
            
            // æ¸…é™¤axios header
            delete axios.defaults.headers.common['Authorization'];
            
            // æ˜¾ç¤ºæç¤ºå¹¶è·³è½¬åˆ°ç™»å½•é¡µé¢
            alert('å·²æˆåŠŸç™»å‡º');
            
            // è·³è½¬åˆ°ç™»å½•é¡µé¢
            setTimeout(() => {
                window.location.href = '/login';
            }, 500);
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥è®¤è¯çŠ¶æ€
        window.addEventListener('load', function() {
            checkAuthStatus();
            
            // ä¸ºç™»å‡ºæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
        });
        
        // ç›‘å¬localStorageå˜åŒ–ï¼ˆå…¶ä»–æ ‡ç­¾é¡µç™»å½•/ç™»å‡ºï¼‰
        window.addEventListener('storage', function(event) {
            if (event.key === 'auth_token' || event.key === 'user_info') {
                checkAuthStatus();
            }
        });
    </script>

</body>
</html>